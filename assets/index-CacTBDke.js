import{ai as Vo,aj as Qt,x as Uo,E as W,ak as Xo,al as Ko,f as Nt,i as eo,S as ut,am as Zo,an as jo,F as qo,C as Lt,P as Ze,ao as St,ap as to,aq as Bt,ar as oo,V as Jo,U as Qo,R as No,I as en,as as kt,at as tn,W as no,au as on,av as nn,D as rn,aw as sn,ax as an,g as ln,Y as cn,ay as dn}from"./three-CzaMwBVW.js";import{W as un,V as Le,C as fn,B as Se}from"./planck-GV3MYWWB.js";import{N as ue,G as pn}from"./keystrokes-BXin2WUB.js";import{G as ro,O as gn}from"./threeaddons-Ce717P9H.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();function ft(...e){let t,o,n,i;if(e.length===0){const l=new Uint32Array(3);window.crypto.getRandomValues(l),e=[l[0],l[1],l[2]]}r(e);function r(l){const f=a();t=f(" "),o=f(" "),n=f(" "),i=1;for(let p=0;p<l.length;p++)t-=f(l[p]),t<0&&(t+=1),o-=f(l[p]),o<0&&(o+=1),n-=f(l[p]),n<0&&(n+=1)}function a(){let l=4022871197;function f(p){p=p.toString();const h=p.length;for(let m=0;m<h;m++){l+=p.charCodeAt(m);let M=.02519603282416938*l;l=M>>>0,M-=l,M*=l,l=M>>>0,M-=l,l+=M*4294967296}return(l>>>0)*23283064365386963e-26}return f}function c(l){return parseInt(l,10)===l}function u(){const l=2091639*t+i*23283064365386963e-26;return t=o,o=n,n=l-(i=l|0),n}return u.fract53=function(){return u()+(u()*2097152|0)*11102230246251565e-32},u.int32=function(){return u()*4294967296},u.cycle=function(l){l=typeof l>"u"?1:Number(l),l<1&&(l=1);for(let f=0;f<l;f++)u()},u.range=function(l=0,f=0){if(l===0&&f===0)return 0;if(l>f){const p=l;l=f,f=p}return c(l)&&c(f)?Math.floor(u()*(f-l+1))+l:u()*(f-l)+l},u.restart=function(){r(e)},u.seed=function(...l){r(l)},u}const hn={_MODULE:"global.js",cameraYpos:0,firstPersonModeActive:!1,mazeExited:!1,orbitControlsEnabled:!1,idleMode:!1,camera:null,exitLight:null,fog:null,physicsWorld:null,playerLight:null,renderer:null,scene:null,errorTexture:null,errorMesh:null,statusBar:null,forceFrameRender:!1},mn={get(e,t){if(t in e)return e[t];throw console.error('Cannot read non existent property "'+t+'" from global'),new Error},set(e,t,o){if(t in e)return e[t]=o,!0;throw console.error('Cannot create new property "'+t+'" on global'),new Error},deleteProperty(e,t){throw console.error('Cannot delete property "'+t+'" from global'),new Error}},s=new Proxy(Object.seal(hn),mn),yn={_MODULE:"config.js",ballRadius:.3,bgColour:1048576,playerLightLevel:.9,textureDir:"./textures/128/",randomSeed:0,soundsDir:"./sounds/",modelDir:"./models/",keyModelFile:"Key.glb",baseModelFile:"TeleporterBase.glb",doorModelFile:"ArchDoor.glb",keySounds:{keyPickup:{filename:"DM-CGS-07.ogg",volume:.4}},keySoundGroups:{},ballTextureFile:"Tile1.png",minVelocity:.1,exitLightY:.4,floorTextureFiles:["Tile8.png","Tile16.png","Tile24.png","Tile25.png"],mazeHeight:1.2,wallTextureFiles:["Tile11.png","Tile4.png","Tile18.png","Tile20.png","Tile21.png","Tile23.png"],mazeSounds:{locked:{filename:"DM-CGS-10.ogg",volume:.3},dm12:{filename:"DM-CGS-12.ogg",volume:.25},dm26:{filename:"DM-CGS-26.ogg",volume:.4},wallhit:{filename:"DM-CGS-03.ogg",volume:.05}},mazeSoundGroups:{mazeExit:["dm12","dm26"]},teleportModelFile:"ArchRound.glb",teleportSounds:{teleport:{filename:"DM-CGS-42.ogg",volume:.1}},controlKeys:{up:["ArrowUp","w","k"],down:["ArrowDown","s","j"],left:["ArrowLeft","a","h"],right:["ArrowRight","d","l"]},keys:{orbit_controls:"control>enter",house_lights:"shift>enter",first_person:"+",jump:"@Space",cycle_minimap:"m"},mouseSensitivity:.005,mapWidthRatio:.25,mapBorderRatio:.0125,idleTimeout:15,keyForce:.4,lightYpos:1.4,jumpSounds:{jump:{filename:"DM-CGS-21.ogg",volume:.3}},cameraEase:.08,cameraExitEase:.04,defaultCameraY:4,enableShadows:!0,exitLightLevel:.5,sunLightLevel:.4},xn={get(e,t){if(t in e)return e[t];throw console.error('Cannot read non existent property "'+t+'" from config'),new Error},set(e,t){throw console.error('Cannot write to property "'+t+'" on config'),new Error},deleteProperty(e,t){throw console.error('Cannot delete property "'+t+'" from config'),new Error}},d=new Proxy(Object.freeze(yn),xn);let O=null,pt=0,Dt=0,gt=0,Be=0,Ht=0;function wn(){O=document.createElement("div"),O.id="statusBar",O.classList.add("status"),document.body.append(O)}function ht(...e){O&&(O.innerHTML=e.join(" "))}function Mn(e){e!==pt&&(pt=e,Dt=0,gt=0,Ct())}function vn(){Dt++,Ct()}function bn(e){gt+=e,Be=Math.round(gt),Be!==Ht&&(Ht=Be,Ct())}function Ct(){O.innerHTML="Level: "+pt+" &nbsp; Distance Rolled: "+Be+" &nbsp; Wall Impacts: "+Dt}function Pn(){const o=new Uint8Array(1024);for(let i=0;i<1024;i+=4)o[i]=255,o[i+1]=105,o[i+2]=180,o[i+3]=255;const n=new Vo(o,16,16);return n.needsUpdate=!0,n}function Ln(){const e=new Qt(.1),t=new Uo({color:16738740});return new W(e,t)}function Sn(e,t){let o=!1,n=!1;const i=new Xo;i.onError=r=>{console.warn("Failed to load asset:",r),n=!0},i.onProgress=function(r,a,c){ht("Loaded",Math.floor(a/c*100)+"%")},i.onLoad=()=>{o&&(n&&console.error("LoadingManager: finished loading asset files with errors"),ht(""),t())},e.forEach(r=>{typeof r.loadAssets=="function"?r.loadAssets(i):console.warn(r,"has no loadAssets method")}),o=!0}const kn=Math.PI/2,Q=ft();function Dn(e,t,o){const n=e<3?3:e|1,i=t<3?3:t|1,r={x:n,z:i},a=o===void 0?Math.random().toString().substring(2):o;Q.seed(a);const c={size:r,data:Array.from({length:r.x},()=>Array(r.z).fill(!1)),deadends:[],seed:a},u=An(r);return c.start=u.start,c.start.angle=0,c.end=u.end,c.exit=u.exit,c.data[c.exit.x][c.exit.z]="H",c}function Cn(e,t,o){const n=Dn(e,t,o);io(n,n.start.x,n.start.z);const{x:i,z:r}=n.start;let a=0;return n.data[i-1][r]!==!1?a=1:n.data[i][r+1]!==!1?a=2:n.data[i+1][r]!==!1&&(a=-1),n.data[n.start.x][n.start.z]="S",n.data[n.end.x][n.end.z]="E",n.start.angle=a*kn,n}function io(e,t,o){let n=t===e.end.x&&o===e.end.z;for(;;){const i=[];let r;if(o<e.size.z-3&&e.data[t][o+2]===!1&&i.push([0,1]),t<e.size.x-3&&e.data[t+2][o]===!1&&i.push([1,0]),o>2&&e.data[t][o-2]===!1&&i.push([0,-1]),t>2&&e.data[t-2][o]===!1&&i.push([-1,0]),i.length===0)return n?e.data[t][o]="*":e.data[t][o]===!1&&(e.data[t][o]="D",e.deadends.push({x:t,z:o})),n;if(e.data[t][o]="",i.length===1?[r]=i:r=i[Math.floor(Q()*i.length)],io(e,t+r[0]*2,o+r[1]*2)?(e.data[t+r[0]][o+r[1]]="*",n=!0):e.data[t+r[0]][o+r[1]]="",i.length===1)return n&&(e.data[t][o]="*"),n}}function An(e){const t={},o={},n=(e.x-1)/2,i=(e.z-1)/2;t.x=Q.range(0,n-1)*2+1,t.z=Q.range(0,i-1)*2+1;let r=t.z<i,a=t.x<n;const c=Q();c>.5?(r=!r,a=!a):c>.25?r=!r:a=!a,o.x=a?1:e.x-2;const u=a?-1:1;o.z=r?1:e.z-2;const l=r?-1:1,f={...o};return Q()>.5?(o.z+=l,o.dir=r?"U":"D"):(o.x+=u,o.dir=a?"L":"R"),{start:t,end:f,exit:o}}let N;const v={};function En(){N=new un({gravity:new Le(0,0)}),N.addContactCallback=_n,s.physicsWorld=N,N.on("begin-contact",e=>{const t=e.m_nodeA.other.m_userData,o=e.m_nodeB.other.m_userData;if(t===void 0||o===void 0)return;const n=typeof t=="object"?t.name:t,i=typeof o=="object"?o.name:o;if(!v[n]||!v[n][i])return;const r=v[n][i],a=performance.now();if(!(a-r.last<250)){if(r.last=a,typeof r.callback=="function"){r.callback(e,t,o);return}r.callback.forEach(c=>{c(e,t,o)})}})}function _n(e,t,o){if(v[e]||(v[e]={}),!v[e][t]){v[e][t]={},v[e][t].last=0,v[e][t].callback=o;return}if(typeof v[e][t].callback=="function"){const n=v[e][t].callback;v[e][t].callback=[n]}v[e][t].callback.push(o)}function Rn(){N.step(1/60),N.clearForces()}let ee=0,te=0;function zn(){function e(){te+=1}function t(){te-=1}function o(){ee-=1}function n(){ee+=1}ue(d.controlKeys.up,{onPressed:t,onReleased:e}),ue(d.controlKeys.down,{onPressed:e,onReleased:t}),ue(d.controlKeys.left,{onPressed:o,onReleased:n}),ue(d.controlKeys.right,{onPressed:n,onReleased:o})}function Tn(e){addEventListener("pointermove",e,!1)}function Fn(e){removeEventListener("pointermove",e)}function ke(e,t,o=void 0){if(!d.keys[e]){console.error("Unknown key index: "+e);return}const n=d.keys[e];n.includes(">")?pn(n,{onPressed:t,onReleased:o}):ue(n,{onPressed:t,onReleased:o})}const Ot=new Le(0,0),ze=new Nt,Y=d.ballRadius,Wt=d.minVelocity;let P,re,He,so=()=>{console.warn("gUpdateMazePosition not set")};function $n(e){new eo(e).load(d.textureDir+"ball/"+d.ballTextureFile,o=>{He=o,He.colorSpace=ut},void 0,()=>{He=s.errorTexture})}function Gn(e){typeof e=="function"&&(so=e),re=s.physicsWorld.createBody({type:"dynamic",position:Ot,awake:!1,fixedRotation:!0,userData:"ball"}),re.createFixture({shape:new fn(Ot,Y),restitution:.15,density:.2});const t=new Qt(Y),o=new Ko({map:He});return P=new W(t,o),P.position.y=Y,P.castShadow=!0,s.scene.add(P),[re,P]}function In(){if(re.isAwake()){const i=re.getLinearVelocity();i.mul(.98),Math.abs(i.x)<Wt&&Math.abs(i.y)<Wt&&(i.x=0,i.y=0)}const e=re.getPosition(),t=e.y,o=e.x-P.position.x,n=t-P.position.z;if(o!==0||n!==0){P.position.set(e.x,P.position.y,t);const i=Math.sqrt(o*o+n*n);return so(e.x,Y,t,i),ze.makeRotationZ(-o/Y),P.matrix.premultiply(ze),ze.makeRotationX(n/Y),P.matrix.premultiply(ze),P.rotation.setFromRotationMatrix(P.matrix),!0}return!1}function Bn(){return Y}const fe={},T={},V={},pe={};let ye=null,je=!1,ao=!1;function Hn(e){const t=new qo(e);t.setResponseType("arraybuffer");for(const o in V)Object.hasOwn(V,o)&&t.load(d.soundsDir+V[o].filename,n=>{fe[o]=n.transfer()})}function Ae(e){for(const t in e)if(Object.hasOwn(e,t)){const o=e[t];typeof o=="string"?V[t]={filename:o,volume:1}:typeof o=="object"&&o.filename&&(V[t]={filename:o.filename},V[t].volume=o.volume?o.volume:1)}}function At(e){for(const t in e)Object.hasOwn(e,t)&&(pe[t]=e[t])}function lo(){document.body.addEventListener("click",()=>{je||uo()},{once:!0}),ao=/firefox/i.test(navigator.userAgent),document.body.addEventListener("keydown",co,{once:!0})}function co(e){if(ao&&e.key.length>1){je||document.body.addEventListener("keydown",co,{once:!0});return}je||uo()}function uo(){ye=new Zo,s.camera.add(ye);const e=new AudioContext;for(const t in fe)Object.hasOwn(fe,t)&&(T[t]||(T[t]=new jo(ye),e.decodeAudioData(fe[t],o=>{T[t].setBuffer(o),T[t].setLoop(!1),T[t].setVolume(V[t].volume),delete fe[t]})));je=!0}function X(e){return ye===null?!0:T[e]?(T[e].isPlaying&&T[e].stop(),T[e].play(),!0):!1}function fo(e){if(ye===null)return!0;if(pe[e]){const t=pe[e].length;if(t>0){const o=Math.floor(Math.random()*t),n=pe[e][o];return X(n)?!0:(pe[e].splice(o,1),!1)}else return!1}return!1}const On="sounds.js",Wn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:On,addAssets:Ae,addGroups:At,loadAssets:Hn,play:X,playFromGroup:fo,setup:lo},Symbol.toStringTag,{value:"Module"})),po=Math.PI/2,Yn=new Lt(16711680),Vn=new Lt(65280);let C,Et,E,ie,se,xe,S,A=null,_t,Rt,Oe,zt=!1,qe=!1,ce;function go(){ce=s.physicsWorld,C=s.scene,Et=s.exitLight,xe=new Ze(16766720,0),C.add(xe),ie=new Ze(16766720,0),C.add(ie),_t=new Se(.5,.04),Rt=new Se(.04,.5),ce.addContactCallback("ball","closed_door",()=>{X("locked")}),zt=!0}function Un(e){const t=new ro(e);t.load(d.modelDir+d.keyModelFile,o=>{E=o.scene,E.traverse(n=>{n instanceof W&&(n.material.emissive={b:0,r:1,g:.7,isColor:!0},n.material.emissiveIntensity=.55)}),E.scale.set(.6,.6,.6)},void 0,()=>{E=s.errorMesh.clone()}),t.load(d.modelDir+d.baseModelFile,o=>{se=o.scene,se.scale.set(.35,.1,.35)},void 0,()=>{se=s.errorMesh.clone()}),t.load(d.modelDir+d.doorModelFile,o=>{S=o.scene,S.scale.set(.42,.4,.3)},void 0,()=>{S=s.errorMesh.clone()}),Ae(d.keySounds),At(d.keySoundGroups)}function ho(e){if(!zt)return;A!==null&&(ce.destroyBody(A),A=null),C.remove(E),C.remove(se),C.remove(S),xe.intensity=0,ie.intensity=0,qe=!1;const t=e;if(Oe=t,t.deadends.length===0){t.key=!1,t.keyIndex=!1;return}const o=Math.floor(Math.random()*t.deadends.length);t.key=t.deadends[o],t.keyIndex=o,t.data[t.key.x][t.key.z]="K";const{x:n,z:i}=t.exit;t.data[n][i]="L";let r=t.exit.x,a=t.exit.z,c;t.exit.dir==="L"||t.exit.dir==="R"?(S.rotation.set(0,po,0),r+=t.exit.dir==="R"?.5:-.5,c=Rt):(S.rotation.set(0,0,0),a+=t.exit.dir==="D"?.5:-.5,c=_t);const u={type:"static",position:{x:r,y:a},userData:"closed_door"};A=ce.createBody(u),A.createFixture({shape:c}),se.position.set(t.key.x,0,t.key.z),C.add(se),xe.position.set(t.key.x,.1,t.key.z),xe.intensity=.04,E.position.set(t.key.x,.38,t.key.z),C.add(E),ie.position.set(t.key.x,.44,t.key.z),ie.intensity=.1,qe=!0,S.position.set(r,0,a),C.add(S),Et.color=Yn}function mo(){return!zt||!qe||s.idleMode?!1:(E.rotateY(.03),E.rotateZ(.03),!0)}function yo(){C.remove(E),ie.intensity=0,qe=!1,X("keyPickup");const{x:e,z:t}=Oe.exit;Oe.data[e][t]="H",A!==null&&(ce.destroyBody(A),A=null);const o=Oe.exit.dir;let n=S.position.x,i=S.position.z,r,a=0;o==="L"||o==="R"?(n+=o==="R"?.5:-.5,i+=.5,r=_t):(a=po,n+=.5,i+=o==="D"?.5:-.5,r=Rt);const c={type:"static",position:{x:n,y:i},userData:"open_door"};A=ce.createBody(c),A.createFixture({shape:r}),S.position.set(n,0,i),S.rotation.set(0,a,0),Et.color=Vn}const Xn="key.js",Kn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:Xn,collect:yo,create:ho,loadAssets:Un,setup:go,update:mo},Symbol.toStringTag,{value:"Module"})),Yt=`

uniform float u_ticks;
uniform float u_opacity;
uniform vec3 u_rgb;
varying vec2 v_Uv;

float random(vec2 st) {
    return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
}

void main() {
    vec3 color = vec3(0.01);
    for (float i = 0.0; i < 10.0; i++) {
        float t = u_ticks * 0.1 + i;
        vec2 blobPos = vec2(random(vec2(i, t)) * 2.0 - 1.0, random(vec2(i + 1.0, t)) * 2.0 - 1.0);
        float d = length(v_Uv - blobPos);
        float intensity = clamp(0.01 / (d * d), 0.0, 0.3);
        color += vec3(intensity * u_rgb.r, intensity * u_rgb.g, intensity * u_rgb.b);
    }
    gl_FragColor = vec4(color, u_opacity);
}

`,Vt=`

varying vec2 v_Uv;

void main() {
    v_Uv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}

`,{PI:De}=Math,Te=De/2,Zn=De*2;let We,xo,wo,Mo,we,rt=!1;const jn=new Se(.5,.01),qn=new Se(.01,.5),B=[];let mt,yt,de,Tt,it;function Jn(e){new ro(e).load(d.modelDir+d.teleportModelFile,o=>{We=o.scene,We.scale.set(.34,.34,2)},void 0,()=>{We=s.errorMesh.clone()}),Ae(d.teleportSounds)}function Qn(){de=s.physicsWorld,Tt=s.scene,we=new St;const e=new to(.79,1.08);mt=new Bt({uniforms:{u_ticks:{value:1},u_opacity:{value:.6},u_rgb:{value:{r:.5,g:.5,b:0}}},vertexShader:Vt,fragmentShader:Yt,transparent:!0}),yt=new Bt({uniforms:{u_ticks:{value:0},u_opacity:{value:.92},u_rgb:{value:{r:0,g:.4,b:.3}}},vertexShader:Vt,fragmentShader:Yt,transparent:!0}),xo=new W(e,mt),wo=new W(e,yt);const t=new oo(1,d.mazeHeight,.14);Nn(t,.14),Mo=new W(t,we),de.addContactCallback("ball","teleporter",or),rt=!0,it=!1}function Nn(e,t){const o=e.getAttribute("uv");[0,4,10,14,21,23,25,27].forEach(n=>{o.array[n]=t}),[2,6,17,19].forEach(n=>{o.array[n]=0}),o.needsUpdate=!0}function er(e,t){if(!rt||e.size.z<11)return;tr(),we.map&&we.map.dispose(),we.map=t.clone();const o=Math.floor((e.size.z-1)/2);if(Fe(1,0,o,"R",2),Fe(2,e.size.x-1,o,"L",1),e.data[0][o]="T",e.data[e.size.x-1][o]="T",e.data[1][o]===!1&&(e.data[1][o]=""),e.data[e.size.x-2][o]===!1&&(e.data[e.size.x-2][o]=""),e.size.x>13){const n=Math.floor((e.size.x-1)/2);Fe(3,n,0,"D",4),Fe(4,n,e.size.z-1,"U",3),e.data[n][0]="T",e.data[n][e.size.z-1]="T",e.data[n][1]===!1&&(e.data[n][1]=""),e.data[n][e.size.z-2]===!1&&(e.data[n][e.size.z-2]="")}B.forEach(n=>{n.active&&Tt.add(n.meshGroup)}),it=!0}function tr(){B.forEach(e=>{Tt.remove(e.meshGroup),e.triggerBody!==null&&(de.destroyBody(e.triggerBody),e.triggerBody=null),e.rearBoxBody!==null&&(de.destroyBody(e.rearBoxBody),e.rearBoxBody=null),e.active=!1}),it=!1}function Fe(e,t,o,n,i){const r={x:0,z:0,meshRotation:0};let a;switch(n){case"R":r.x=-1,r.meshRotation=Te,a=-Te;break;case"L":r.x=1,r.meshRotation=-Te,a=Te;break;case"D":r.z=-1,r.meshRotation=0,a=0;break;case"U":r.z=1,r.meshRotation=De,a=De;break;default:console.warn("invalid entrySide value:",n);return}B[e]||(B[e]={meshGroup:null});const c=B[e];if(c.meshGroup===null){c.meshGroup=new Qo;const f=We.clone();f.position.set(0,0,.23),c.meshGroup.add(f);const p=xo.clone();p.position.set(0,.5,-.12),c.meshGroup.add(p);const h=wo.clone();h.position.set(0,.5,-.27),c.meshGroup.add(h);const m=Mo.clone();m.position.set(0,d.mazeHeight/2,-.43),c.meshGroup.add(m)}c.meshGroup.position.set(t,0,o),c.meshGroup.rotation.set(0,r.meshRotation,0);const u=r.x!==0?qn:jn,l={type:"static",position:{x:t+r.x*.44,y:o+r.z*.44},userData:{name:"teleporter",id:e}};c.triggerBody=de.createBody(l),c.triggerBody.createFixture({shape:u}),l.position={x:t+r.x*.5,y:o+r.z*.5},l.userData={},c.rearBoxBody=de.createBody(l),c.rearBoxBody.createFixture({shape:u}),c.index=e,c.target=i,c.exit={x:t-r.x*.1,z:o-r.z*.1},c.cameraRotation=a,c.active=!0}function or(e,t,o){if(!rt)return;const n=B[o.id];if(!n.target){console.warn("no destination teleporter set:",o.id);return}if(!B[n.target]){console.warn("destination teleporter does not exist:",n.target);return}const i=B[n.target];if(!i.exit){console.warn("destination has no exit data:",n.target);return}const r=(i.cameraRotation-n.cameraRotation+De)%Zn,a=Eo().clone(),c=new Jo(a.x,a.y);c.rotateAround({x:0,y:0},r),c.multiplyScalar(.75),zo(i.exit,c,r),X("teleport")}function nr(){return!rt||!it||s.idleMode?!1:(mt.uniforms.u_ticks.value+=2e-7,yt.uniforms.u_ticks.value+=9e-8,!0)}const Ut=Math.PI/2,Ce=[],Je=[],$e=[],vo=[],y={x:0,z:0,type:""};let oe,Ye,Me,_,k,ne,xt=.9,Qe;function bo(){Qe=s.physicsWorld,oe=s.scene,Ye=s.camera,Me=new Ze(65280,0),oe.add(Me),s.exitLight=Me,ne={size:{x:0,z:0}},Qe.addContactCallback("ball","wall",e=>{const t=e.getManifold().localNormal,o=e.getFixtureB().getBody().getLinearVelocity(),n=Math.abs(o.x*t.x),i=Math.abs(o.y*t.y);(n>xt||i>xt)&&(X("wallhit"),vn())}),Qn()}function rr(e){const t=new eo(e);for(const o of d.wallTextureFiles)t.load(d.textureDir+"walls/"+o,n=>{n.colorSpace=ut,Ce.push(n)},void 0,()=>{Ce.push(s.errorTexture)});for(const o of d.floorTextureFiles)t.load(d.textureDir+"floors/"+o,n=>{n.colorSpace=ut,Je.push(n)},void 0,()=>{Je.push(s.errorTexture)});Ae(d.mazeSounds),At(d.mazeSoundGroups),Jn(e)}function Po(e,t=.9){ne=e,xt=t;const o=Math.floor(Math.random()*Ce.length);er(e,Ce[o]),$e.length>0&&($e.forEach(p=>Qe.destroyBody(p)),$e.length=0);const n={type:"static",position:{x:0,y:0},userData:"wall"},i=new Se(.5,.5);for(let p=0;p<e.size.x;p++)for(let h=0;h<e.size.z;h++)if(e.data[p][h]===!1){n.position={x:p,y:h};const m=Qe.createBody(n);$e.push(m),m.createFixture({shape:i})}const r=e.size.x,a=e.size.z;_&&(oe.remove(_),_.geometry.dispose(),_.material.dispose(),_=null),k&&(oe.remove(k),k.geometry.dispose(),k.material.dispose(),k=null),_=ir(e,o),_.castShadow=!0,_.receiveShadow=!0,oe.add(_);const c=Math.floor(Math.random()*Je.length),u=Je[c];u.wrapS=u.wrapT=No,u.repeat.set(r+15,a+15);const l=new to(r+15,a+15),f=new St({map:u});k=new W(l,f),k.rotateX(-Ut),k.position.set((r-1)/2,0,(a-1)/2),k.receiveShadow=!0,oe.add(k),s.firstPersonModeActive?Ye.rotation.set(0,e.start.angle,0):Ye.rotation.set(-Ut,0,0),Ye.position.set(e.start.x,s.cameraYpos,e.start.z),Me.position.set(e.exit.x,d.exitLightY,e.exit.z),Me.intensity=0,s.mazeExited=!1}function ir(e,t){const o=new oo(1,d.mazeHeight,1),n=Ce[t],i=new St({map:n}),r=new en(o,i,e.size.x*e.size.z);r.count=0;const a=new Nt;for(let c=0;c<e.size.x;c++)for(let u=0;u<e.size.z;u++)e.data[c][u]===!1&&(a.setPosition(c,d.mazeHeight/2,u),r.setMatrixAt(r.count++,a));return r}function Lo(e,t,o,n){bn(n);const i=Math.floor(e+.5),r=Math.floor(o+.5),a={x:y.x,z:y.z},c={x:e,z:o};if(i===a.x&&r===a.z)return;const u=y.type;y.x=i,y.z=r,i>=0&&i<ne.size.x&&r>=0&&r<ne.size.z?y.type=ne.data[y.x][y.z]:y.type="O",y.type!==u&&(y.type==="K"&&(yo(),ne.data[y.x][y.z]="D"),vo.forEach(l=>{(l.from===null||l.from===u)&&(l.to===null||l.to===y.type)&&l.callback(u,y.type,a,c)}))}function sr(e,t=null,o=null){vo.push({from:o,to:t,callback:e})}function Ft(){return y}function So(){return nr()}const ar="maze.js",lr=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:ar,create:Po,getPlayerGridInfo:Ft,loadAssets:rr,registerOnTypeChange:sr,setup:bo,update:So,updatePlayerPosition:Lo},Symbol.toStringTag,{value:"Module"}));let Xt=1,ge=-1,$t,ae=null,ve=null,Ve=!1,st=!1,Ne,et,wt=!1;function cr(){Ae(d.jumpSounds)}function dr(e){Ne=s.camera,et=s.playerLight,$t=e.position.y,ke("jump",()=>{wt=!0},()=>{wt=!1})}function ur(e){if(!Ve&&!wt)return!1;const{firstPersonModeActive:t}=s;if(Ve||(Ve=!0,st=t,Xt=Ft().type==="T"?.5:1.1,ge=-1,st&&(ae=Ne.position.y),ve=et.position.y,X("jump")),t!==st)return ae=null,Mt(e),!0;if(ge+=.05,ge>1)return Mt(e),!0;const o=1-ge**2,n=Xt*o;return t&&(Ne.position.y=ae+n*1.28),e.position.y=$t+n,et.position.y=ve+n,!0}function Mt(e){e.position.y=$t,ve!==null&&(et.position.y=ve,ve=null),ae!==null&&(s.firstPersonModeActive&&(Ne.position.y=ae),ae=null),ge=-1,Ve=!1}let H,Ee,I,le=0,ko=()=>{console.warn("gUpdateMazePosition not set")},he=null,Ue=null,me=null;const at=new kt(0,0,0,"YZX");let vt,Ge=0;const fr=new Le(0,0),Do=Math.PI/4,pr=Math.sin(Do),gr=Math.cos(Do);function hr(e){$n(e),cr()}function Co(e){vt=s.camera,typeof e=="function"&&(ko=e),[Ee,H]=Gn(e),I=new Ze(16769248,d.playerLightLevel),I.castShadow=!1,s.scene.add(I),s.playerLight=I,dr(H)}function bt(){if(he!==null&&(Ro(he.x,he.z),he=null,Ue!==null&&(Ao(Ue),Ue=null),me!==null&&(s.firstPersonModeActive&&(at.setFromQuaternion(vt.quaternion),at.y-=me,vt.quaternion.setFromEuler(at),le+=me),me=null)),ee!==0||te!==0){let t;if(ee!==0&&te!==0?t=new Le(ee*gr,te*pr):t=new Le(ee,te),t.mul(d.keyForce),s.firstPersonModeActive){const o=Math.cos(le),n=Math.sin(le),i=o*t.x-n*t.y,r=n*t.x+o*t.y;t.x=i,t.y=r}mr(t)}I.position.x=H.position.x,I.position.z=H.position.z;let e=In();return e|=ur(H),e&&(Ge=0,s.idleMode=!1),!e&&!s.idleMode&&(Ge===0?Ge=Date.now():Date.now()-Ge>d.idleTimeout*1e3&&(s.idleMode=!0)),e}function Ao(e){Ee.setLinearVelocity(e)}function Eo(){return Ee.getLinearVelocity()}function _o(e){Ao(fr),Ro(e.start.x,e.start.z),le=-e.start.angle,I.position.set(e.start.x,d.lightYpos,e.start.z),I.intensity=0,Mt(H)}function Ro(e,t){const o=_e();H.position.set(e,o.y,t),Ee.setPosition({x:e,y:t}),ko(e,o.y,t,0)}function zo(e,t=null,o=null){he=e,Ue=t,me=o}function _e(){return H.position}function To(){return Bn()}function mr(e){Ee.applyForceToCenter(e)}function Gt(){return le}function Fo(e){le=e}const yr="player.js",xr=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:yr,deferredPositionUpdate:zo,getAngle:Gt,getCameraHeight:To,getLinearVelocity:Eo,getPosition:_e,loadAssets:hr,setAngle:Fo,setNewMaze:_o,setup:Co,update:bt},Symbol.toStringTag,{value:"Module"}));let x,j,b,R;function wr(e=document.body){s.cameraYpos=d.defaultCameraY,j=new tn,s.scene=j,b=new no(80,window.innerWidth/window.innerHeight),s.camera=b,R=new on({antialias:!0}),s.renderer=R,R.shadowMap.enabled=d.enableShadows,R.shadowMap.type=nn,e.appendChild(R.domElement),R.setPixelRatio(window.devicePixelRatio),R.setSize(window.innerWidth,window.innerHeight),Go(),window.addEventListener("resize",br),j.background=new Lt(d.bgColour),x=new rn(16777215,d.sunLightLevel),x.castShadow=!0,x.position.set(5,20,5),x.shadow.camera.left=-10,x.shadow.camera.right=10,x.shadow.camera.top=0,x.shadow.camera.bottom=-20,x.shadow.camera.near=10,x.shadow.camera.far=25,j.add(x),s.fog=new sn(d.bgColour,5,10),j.fog=s.fog}function $o(e=!0){let t=e;if(!s.orbitControlsEnabled){const o=_e();if(s.firstPersonModeActive)b.position.x=o.x,b.position.z=o.z;else{const n=o.x-b.position.x,i=o.z-b.position.z;if(n!==0||i!==0){t=!0;const r=s.mazeExited?d.cameraExitEase:d.cameraEase;r>=1||Math.abs(n)<.008&&Math.abs(i)<.008?(b.position.x=o.x,b.position.z=o.z):(b.position.x+=n*r,b.position.z+=i*r)}}}return s.forceFrameRender&&(t=!0,s.forceFrameRender=!1),t?(R.render(j,b),!0):!1}function Mr(){const e=.1*(d.playerLightLevel-s.playerLight.intensity),t=.1*(d.sunLightLevel-x.intensity);return s.playerLight.intensity+=e,x.intensity+=t,e<.01?(s.playerLight.intensity=d.playerLightLevel,s.exitLight.intensity=d.exitLightLevel,x.intensity=d.sunLightLevel,!0):!1}function vr(){const e=.04*s.playerLight.intensity;return s.playerLight.intensity-=e,s.exitLight.intensity-=e,x.intensity-=e/2,e<.01?(s.playerLight.intensity=0,s.exitLight.intensity=0,x.intensity=0,!0):!1}function br(){Go(),$o()}function Go(){b.aspect=window.innerWidth/window.innerHeight,b.updateProjectionMatrix(),R.setSize(window.innerWidth,window.innerHeight)}var be=function(){var e=0,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",function(f){f.preventDefault(),n(++e%t.children.length)},!1);function o(f){return t.appendChild(f.dom),f}function n(f){for(var p=0;p<t.children.length;p++)t.children[p].style.display=p===f?"block":"none";e=f}var i=(performance||Date).now(),r=i,a=0,c=o(new be.Panel("FPS","#0ff","#002")),u=o(new be.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=o(new be.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:t,addPanel:o,showPanel:n,begin:function(){i=(performance||Date).now()},end:function(){a++;var f=(performance||Date).now();if(u.update(f-i,200),f>=r+1e3&&(c.update(a*1e3/(f-r),100),r=f,a=0,l)){var p=performance.memory;l.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return f},update:function(){i=this.end()},domElement:t,setMode:n}};be.Panel=function(e,t,o){var n=1/0,i=0,r=Math.round,a=r(window.devicePixelRatio||1),c=80*a,u=48*a,l=3*a,f=2*a,p=3*a,h=15*a,m=74*a,M=30*a,K=document.createElement("canvas");K.width=c,K.height=u,K.style.cssText="width:80px;height:48px";var g=K.getContext("2d");return g.font="bold "+9*a+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=o,g.fillRect(0,0,c,u),g.fillStyle=t,g.fillText(e,l,f),g.fillRect(p,h,m,M),g.fillStyle=o,g.globalAlpha=.9,g.fillRect(p,h,m,M),{dom:K,update:function(Re,Yo){n=Math.min(n,Re),i=Math.max(i,Re),g.fillStyle=o,g.globalAlpha=1,g.fillRect(0,0,c,h),g.fillStyle=t,g.fillText(r(Re)+" "+e+" ("+r(n)+"-"+r(i)+")",l,f),g.drawImage(K,p+a,h,m-a,M,p,h,m-a,M),g.fillRect(p+m-a,h,a,M),g.fillStyle=o,g.globalAlpha=.9,g.fillRect(p+m-a,h,a,r((1-Re/Yo)*M))}}};let lt=!1,w,Pe,Kt,tt,U,ot;function Pr(){U=s.camera,ot=s.scene,tt=new be,document.body.appendChild(tt.dom),ke("orbit_controls",Sr),ke("house_lights",kr),w=new gn(U,s.renderer.domElement),w.enableDamping=!0,w.enabled=!1,w.minPolarAngle=.02,w.maxPolarAngle=Math.PI-.05,Pe=new an(13421772,1),Pe.intensity=0,ot.add(Pe)}function Lr(){return tt&&tt.update(),w.enabled?(w.update(),!0):!1}function Sr(){if(s.firstPersonModeActive){console.log("Cannot activate orbit controls while in first person view");return}w.enabled=!w.enabled,s.orbitControlsEnabled=w.enabled;const e=_e();w.enabled?(console.log("Orbit controls enabled"),Kt=U.position.y,w.target.set(e.x,e.y,e.z)):(console.log("Orbit controls disabled"),U.position.set(e.x,Kt,e.z),U.rotation.set(3*Math.PI/2,0,0),s.forceFrameRender=!0)}function kr(){lt=!lt,lt?(Pe.intensity=1,ot.fog=null,console.log("House lights up")):(Pe.intensity=0,ot.fog=s.fog,console.log("House lights down")),s.forceFrameRender=!0}function Dr(){w&&w.target.set(U.position.x,d.ballRadius,U.position.z)}const Z=new kt(0,0,0,"YZX"),ct=new ln,Cr="pointerLockElement"in document;let Xe=0,Ke=0,$;const Io=Math.PI/2,Zt=Io-1e-5;function Ar(){if(!Cr){console.log("browser does not support pointer lock, no first person view available");return}$=s.camera,ke("first_person",Er),document.addEventListener("pointerlockchange",()=>{if(s.orbitControlsEnabled){document.pointerLockElement&&(console.log("Cannot switch to first person view while orbit controls are active"),document.exitPointerLock());return}s.firstPersonModeActive?(document.exitPointerLock(),$.rotation.set(-Io,0,0),$.position.y=s.cameraYpos=d.defaultCameraY,Fn(jt),s.firstPersonModeActive=!1,console.log("first person view disabled")):($.rotation.set(0,-Gt(),0),$.position.y=s.cameraYpos=To(),Tn(jt),s.firstPersonModeActive=!0,console.log("first person view enabled")),s.forceFrameRender=!0})}function Er(){s.firstPersonModeActive?document.exitPointerLock():s.renderer.domElement.requestPointerLock()}function jt(e){const t=e.movementX||e.mozMovementX||e.webkitMovementX||0;Xe=(e.movementY||e.mozMovementY||e.webkitMovementY||0)*d.mouseSensitivity,Ke=t*d.mouseSensitivity}function _r(){if(!s.firstPersonModeActive)return!1;let e=!1;return(Xe!==0||Ke!==0)&&(Z.setFromQuaternion($.quaternion),Z.x-=Xe,Z.y-=Ke,Z.x=Math.max(-Zt,Math.min(Zt,Z.x)),$.quaternion.setFromEuler(Z),$.getWorldDirection(ct),Fo(Math.atan2(ct.x,-ct.z)),Xe=0,Ke=0,e=!0),e}const qt=Math.PI/2,Bo=new dn,Ie=new kt(0,0,0,"YZX"),D=Object.freeze({disabled:0,perpective:1,orthographic:2});let z,Ho,Oo,nt,Wo,G,q,J,It=!1;function Rr(){q=new no(70),q.position.x=0,q.position.y=6,q.position.z=0,q.rotation.set(-qt,0,0),J=new cn(-3,3,3,-3),J.position.x=0,J.position.y=6,J.position.z=0,J.rotation.set(-qt,0,0),z=D.perpective,Wo=s.scene,G=s.renderer,Jt(),window.addEventListener("resize",Jt),ke("cycle_minimap",zr),It=!0}function zr(){if(!(!s.firstPersonModeActive||!It)){switch(z){case D.disabled:z=D.perpective;break;case D.perpective:z=D.orthographic;break;case D.orthographic:z=D.disabled;break;default:console.error("minimap was in an unknown state:",z),z=D.perpective;break}s.forceFrameRender=!0}}function Tr(){if(!s.firstPersonModeActive||!It||z===D.disabled)return;const e=z===D.perpective?q:J,t=_e();e.position.x=t.x,e.position.z=t.z;const o=-Gt();Ie.setFromQuaternion(e.quaternion),Math.abs(Ie.y-o)>.001&&(Ie.y=o,e.quaternion.setFromEuler(Ie)),G.setViewport(Ho,Oo,nt,nt),G.setScissorTest(!0),G.render(Wo,e),G.setScissorTest(!1),G.setViewport(Bo)}function Jt(){const e=Math.min(window.innerHeight,window.innerWidth);nt=Math.floor(e*d.mapWidthRatio);const t=Math.floor(e*d.mapBorderRatio),o=nt+t*2,n=window.innerWidth-o,i=window.innerHeight-o;Ho=n+t,Oo=i+t,G.setScissor(n,i,o,o),G.getViewport(Bo)}Math.random=d.randomSeed?ft(d.randomSeed):ft();s.errorTexture=Pn();s.errorMesh=Ln();const L=Object.freeze({init:0,fadeIn:1,play:2,fadeOut:3,delay:4});let dt=1,F=L.init;const{promise:Fr,resolve:$r}=Promise.withResolvers();document.addEventListener("DOMContentLoaded",()=>{wn(),ht("Loading..."),Sn([xr,lr,Kn,Wn],$r)});await Fr;Gr();requestAnimationFrame(Pt);function Gr(){En(),wr(),zn(),Pr(),Ar(),Rr(),bo(),go(),Co(Lo),lo()}function Pt(){let e=!0;switch(F){case L.init:{Mn(dt);const t=Math.random().toString().substring(2),o=5+dt*2,n=Cn(o,o,t);Po(n),ho(n),_o(n),Dr(),F=L.fadeIn}break;case L.fadeIn:Mr()&&(F=L.play);break;case L.play:e=bt(),e|=_r(),e|=mo(),e|=So(),Ft().type==="O"&&(dt++,s.mazeExited=!0,F=L.fadeOut,fo("mazeExit"));break;case L.fadeOut:bt(),vr()&&(F=L.delay);break;case L.delay:setTimeout(()=>{F=L.init,requestAnimationFrame(Pt)},800);return;default:console.log("game_loop(): Unknown game state: "+F),F=L.pause;break}e|=Lr(),Rn(),$o(e)&&Tr(),requestAnimationFrame(Pt)}
