import{ai as go,aj as kt,x as ho,E as F,ak as yo,al as mo,f as Dt,i as Et,S as Ye,am as xo,an as wo,F as Mo,C as rt,P as Ce,ao as it,ap as At,aq as yt,ar as _t,V as vo,U as bo,R as Lo,I as Po,as as Ct,at as So,W as ko,au as Do,av as Eo,D as Ao,aw as _o,ax as Co,g as To}from"./three-BnTik3_w.js";import{W as zo,V as fe,C as Ro,B as pe}from"./planck-C4Ttdjc7.js";import{N as Q,G as Fo}from"./keystrokes-BXin2WUB.js";import{G as Tt,O as Go}from"./threeaddons-BODZ3vLA.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();function Ve(...e){let t,o,r,i;if(e.length===0){const l=new Uint32Array(3);window.crypto.getRandomValues(l),e=[l[0],l[1],l[2]]}s(e);function s(l){const f=a();t=f(" "),o=f(" "),r=f(" "),i=1;for(let p=0;p<l.length;p++)t-=f(l[p]),t<0&&(t+=1),o-=f(l[p]),o<0&&(o+=1),r-=f(l[p]),r<0&&(r+=1)}function a(){let l=4022871197;function f(p){p=p.toString();const h=p.length;for(let y=0;y<h;y++){l+=p.charCodeAt(y);let v=.02519603282416938*l;l=v>>>0,v-=l,v*=l,l=v>>>0,v-=l,l+=v*4294967296}return(l>>>0)*23283064365386963e-26}return f}function c(l){return parseInt(l,10)===l}function u(){const l=2091639*t+i*23283064365386963e-26;return t=o,o=r,r=l-(i=l|0),r}return u.fract53=function(){return u()+(u()*2097152|0)*11102230246251565e-32},u.int32=function(){return u()*4294967296},u.cycle=function(l){l=typeof l>"u"?1:Number(l),l<1&&(l=1);for(let f=0;f<l;f++)u()},u.range=function(l=0,f=0){if(l===0&&f===0)return 0;if(l>f){const p=l;l=f,f=p}return c(l)&&c(f)?Math.floor(u()*(f-l+1))+l:u()*(f-l)+l},u.restart=function(){s(e)},u.seed=function(...l){s(l)},u}const $o={_MODULE:"global.js",cameraYpos:0,idleStartMs:0,firstPersonModeActive:!1,mazeExited:!1,orbitControlsEnabled:!1,idleMode:!1,camera:null,exitLight:null,fog:null,physicsWorld:null,playerLight:null,renderer:null,renderUpdate:()=>{console.warn("global.renderUpdate not set")},scene:null,errorTexture:null,errorMesh:null,statusBar:null},Io={get(e,t){if(t in e)return e[t];throw console.error('Cannot read non existent property "'+t+'" from global'),new Error},set(e,t,o){if(t in e)return e[t]=o,!0;throw console.error('Cannot create new property "'+t+'" on global'),new Error},deleteProperty(e,t){throw console.error('Cannot delete property "'+t+'" from global'),new Error}},n=new Proxy(Object.seal($o),Io),Bo={_MODULE:"config.js",ballRadius:.3,bgColour:1048576,playerLightLevel:.9,textureDir:"./textures/128/",randomSeed:0,soundsDir:"./sounds/",modelDir:"./models/",keyModelFile:"Key.glb",baseModelFile:"TeleporterBase.glb",doorModelFile:"ArchDoor.glb",keySounds:{keyPickup:{filename:"DM-CGS-07.ogg",volume:.4}},keySoundGroups:{},ballTextureFile:"Tile1.png",minVelocity:.1,exitLightY:.4,floorTextureFiles:["Tile8.png","Tile16.png","Tile24.png","Tile25.png"],mazeHeight:1.2,wallTextureFiles:["Tile11.png","Tile4.png","Tile18.png","Tile20.png","Tile21.png","Tile23.png"],mazeSounds:{locked:{filename:"DM-CGS-10.ogg",volume:.3},dm12:{filename:"DM-CGS-12.ogg",volume:.25},dm26:{filename:"DM-CGS-26.ogg",volume:.4},wallhit:{filename:"DM-CGS-03.ogg",volume:.05}},mazeSoundGroups:{mazeExit:["dm12","dm26"]},teleportModelFile:"ArchRound.glb",teleportSounds:{teleport:{filename:"DM-CGS-42.ogg",volume:.1}},controlKeys:{up:["ArrowUp","w","k"],down:["ArrowDown","s","j"],left:["ArrowLeft","a","h"],right:["ArrowRight","d","l"]},keys:{orbit_controls:"control>enter",house_lights:"shift>enter",first_person:"+",jump:"@Space"},mouseSensitivity:.005,idleTimeout:15,keyForce:.4,lightYpos:1.4,jumpSounds:{jump:{filename:"DM-CGS-21.ogg",volume:.3}},cameraEase:.08,cameraExitEase:.04,defaultCameraY:4,enableShadows:!0,exitLightLevel:.5,sunLightLevel:.4},Ho={get(e,t){if(t in e)return e[t];throw console.error('Cannot read non existent property "'+t+'" from config'),new Error},set(e,t){throw console.error('Cannot write to property "'+t+'" on config'),new Error},deleteProperty(e,t){throw console.error('Cannot delete property "'+t+'" from config'),new Error}},d=new Proxy(Object.freeze(Bo),Ho);let C=null,mt=0,Xe=0,st=0,Ke=0,Le=0,xt=0;function Uo(){return C=document.createElement("div"),C.id="statusBar",C.classList.add("status"),document.body.append(C),mt=C===null?0:C.clientHeight,mt}function je(...e){C&&(C.innerHTML=e.join(" "))}function Wo(e){e!==Xe&&(Xe=e,st=0,Ke=0,at())}function Oo(){st++,at()}function Yo(e){Ke+=e,Le=Math.round(Ke),Le!==xt&&(xt=Le,at())}function at(){C.innerHTML="Level: "+Xe+" &nbsp; Distance Rolled: "+Le+" &nbsp; Wall Impacts: "+st}function Vo(){const o=new Uint8Array(1024);for(let i=0;i<1024;i+=4)o[i]=255,o[i+1]=105,o[i+2]=180,o[i+3]=255;const r=new go(o,16,16);return r.needsUpdate=!0,r}function Xo(){const e=new kt(.1),t=new ho({color:16738740});return new F(e,t)}function Ko(e,t){let o=!1,r=!1;const i=new yo;i.onError=s=>{console.warn("Failed to load asset:",s),r=!0},i.onProgress=function(s,a,c){je("Loaded",Math.floor(a/c*100)+"%")},i.onLoad=()=>{o&&(r&&console.error("LoadingManager: finished loading asset files with errors"),je(""),t())},e.forEach(s=>{typeof s.loadAssets=="function"?s.loadAssets(i):console.warn(s,"has no loadAssets method")}),o=!0}const jo=Math.PI/2,U=Ve();function Zo(e,t,o){const r=e<3?3:e|1,i=t<3?3:t|1,s={x:r,z:i},a=o===void 0?Math.random().toString().substring(2):o;U.seed(a);const c={size:s,data:Array.from({length:s.x},()=>Array(s.z).fill(!1)),deadends:[],seed:a},u=Jo(s);return c.start=u.start,c.start.angle=0,c.end=u.end,c.exit=u.exit,c.data[c.exit.x][c.exit.z]="H",c}function qo(e,t,o){const r=Zo(e,t,o);zt(r,r.start.x,r.start.z);const{x:i,z:s}=r.start;let a=0;return r.data[i-1][s]!==!1?a=1:r.data[i][s+1]!==!1?a=2:r.data[i+1][s]!==!1&&(a=3),r.data[r.start.x][r.start.z]="S",r.data[r.end.x][r.end.z]="E",r.start.angle=a*jo,r}function zt(e,t,o){let r=t===e.end.x&&o===e.end.z;for(;;){const i=[];let s;if(o<e.size.z-3&&e.data[t][o+2]===!1&&i.push([0,1]),t<e.size.x-3&&e.data[t+2][o]===!1&&i.push([1,0]),o>2&&e.data[t][o-2]===!1&&i.push([0,-1]),t>2&&e.data[t-2][o]===!1&&i.push([-1,0]),i.length===0)return r?e.data[t][o]="*":e.data[t][o]===!1&&(e.data[t][o]="D",e.deadends.push({x:t,z:o})),r;if(e.data[t][o]="",i.length===1?[s]=i:s=i[Math.floor(U()*i.length)],zt(e,t+s[0]*2,o+s[1]*2)?(e.data[t+s[0]][o+s[1]]="*",r=!0):e.data[t+s[0]][o+s[1]]="",i.length===1)return r&&(e.data[t][o]="*"),r}}function Jo(e){const t={},o={};let r=U()>.5,i=U()>.5;t.x=i?1:e.x-2,t.z=r?1:e.z-2;const s=U();s>.5?(r=!r,i=!i):s>.25?r=!r:i=!i,o.x=i?1:e.x-2;const a=i?-1:1;o.z=r?1:e.z-2;const c=r?-1:1,u={...o};return U()>.5?(o.z+=c,o.dir=r?"U":"D"):(o.x+=a,o.dir=i?"L":"R"),{start:t,end:u,exit:o}}let ne;const b={};function Qo(){ne=new zo({gravity:new fe(0,0)}),n.physicsWorld=ne,n.physicsWorld.addContactCallback=No,ne.on("begin-contact",e=>{const t=e.m_nodeA.other.m_userData,o=e.m_nodeB.other.m_userData;if(t===void 0||o===void 0)return;const r=typeof t=="object"?t.name:t,i=typeof o=="object"?o.name:o;if(!b[r]||!b[r][i])return;const s=b[r][i],a=performance.now();if(!(a-s.last<250)){if(s.last=a,typeof s.callback=="function"){s.callback(e,t,o);return}s.callback.forEach(c=>{c(e,t,o)})}})}function No(e,t,o){if(b[e]||(b[e]={}),!b[e][t]){b[e][t]={},b[e][t].last=0,b[e][t].callback=o;return}if(typeof b[e][t].callback=="function"){const r=b[e][t].callback;b[e][t].callback=[r]}b[e][t].callback.push(o)}function en(){ne.step(1/60),ne.clearForces()}let W=0,O=0;function tn(){function e(){O+=1}function t(){O-=1}function o(){W-=1}function r(){W+=1}Q(d.controlKeys.up,{onPressed:t,onReleased:e}),Q(d.controlKeys.down,{onPressed:e,onReleased:t}),Q(d.controlKeys.left,{onPressed:o,onReleased:r}),Q(d.controlKeys.right,{onPressed:r,onReleased:o})}function on(e){addEventListener("pointermove",e,!1)}function nn(e){removeEventListener("pointermove",e)}function Te(e,t){if(!d.keys[e]){console.error("Unknown key index: "+e);return}const o=d.keys[e];o.includes(">")?Fo(o,t):Q(o,t)}const wt=new fe(0,0),we=new Dt,G=d.ballRadius,Mt=d.minVelocity;let M,K,Pe,Rt=()=>{console.warn("gUpdateMazePosition not set")};function rn(e){new Et(e).load(d.textureDir+"ball/"+d.ballTextureFile,o=>{Pe=o,Pe.colorSpace=Ye},void 0,()=>{Pe=n.errorTexture})}function sn(e){typeof e=="function"&&(Rt=e),K=n.physicsWorld.createBody({type:"dynamic",position:wt,awake:!1,fixedRotation:!0,userData:"ball"}),K.createFixture({shape:new Ro(wt,G),restitution:.15,density:.2});const t=new kt(G),o=new mo({map:Pe});return M=new F(t,o),M.position.y=G,M.castShadow=!0,n.scene.add(M),[K,M]}function an(){if(K.isAwake()){const i=K.getLinearVelocity();i.mul(.98),Math.abs(i.x)<Mt&&Math.abs(i.y)<Mt&&(i.x=0,i.y=0)}const e=K.getPosition(),t=e.y,o=e.x-M.position.x,r=t-M.position.z;if(o!==0||r!==0){M.position.set(e.x,M.position.y,t);const i=Math.sqrt(o*o+r*r);return Rt(e.x,G,t,i),n.firstPersonModeActive||(we.makeRotationZ(-o/G),M.matrix.premultiply(we),we.makeRotationX(r/G),M.matrix.premultiply(we),M.rotation.setFromRotationMatrix(M.matrix)),!0}return!1}function ln(){return G}function cn(e){M.visible=!e}const N={},T={},$={},ee={};let re=null,ze=!1,Ft=!1;function dn(e){const t=new Mo(e);t.setResponseType("arraybuffer");for(const o in $)Object.hasOwn($,o)&&t.load(d.soundsDir+$[o].filename,r=>{N[o]=r.transfer()})}function ye(e){for(const t in e)if(Object.hasOwn(e,t)){const o=e[t];typeof o=="string"?$[t]={filename:o,volume:1}:typeof o=="object"&&o.filename&&($[t]={filename:o.filename},$[t].volume=o.volume?o.volume:1)}}function lt(e){for(const t in e)Object.hasOwn(e,t)&&(ee[t]=e[t])}function Gt(){document.body.addEventListener("click",()=>{ze||It()},{once:!0}),Ft=/firefox/i.test(navigator.userAgent),document.body.addEventListener("keydown",$t,{once:!0})}function $t(e){if(Ft&&e.key.length>1){ze||document.body.addEventListener("keydown",$t,{once:!0});return}ze||It()}function It(){re=new xo,n.camera.add(re);const e=new AudioContext;for(const t in N)Object.hasOwn(N,t)&&(T[t]||(T[t]=new wo(re),e.decodeAudioData(N[t],o=>{T[t].setBuffer(o),T[t].setLoop(!1),T[t].setVolume($[t].volume),delete N[t]})));ze=!0}function I(e){return re===null?!0:T[e]?(T[e].isPlaying&&T[e].stop(),T[e].play(),!0):!1}function Bt(e){if(re===null)return!0;if(ee[e]){const t=ee[e].length;if(t>0){const o=Math.floor(Math.random()*t),r=ee[e][o];return I(r)?!0:(ee[e].splice(o,1),!1)}else return!1}return!1}const un="sounds.js",fn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:un,addAssets:ye,addGroups:lt,loadAssets:dn,play:I,playFromGroup:Bt,setup:Gt},Symbol.toStringTag,{value:"Module"})),Ht=Math.PI/2,pn=new rt(16711680),gn=new rt(65280);let S,ct,E,j,Z,ie,L,k=null,dt,ut,Se,ft=!1,Re=!1;function Ut(){S=n.scene,ct=n.exitLight,ie=new Ce(16766720,0),S.add(ie),j=new Ce(16766720,0),S.add(j),dt=new pe(.5,.04),ut=new pe(.04,.5),n.physicsWorld.addContactCallback("ball","closed_door",()=>{I("locked")}),ft=!0}function hn(e){const t=new Tt(e);t.load(d.modelDir+d.keyModelFile,o=>{E=o.scene,E.traverse(r=>{r instanceof F&&(r.material.emissive={b:0,r:1,g:.7,isColor:!0},r.material.emissiveIntensity=.55)}),E.scale.set(.6,.6,.6)},void 0,()=>{E=n.errorMesh.clone()}),t.load(d.modelDir+d.baseModelFile,o=>{Z=o.scene,Z.scale.set(.35,.1,.35)},void 0,()=>{Z=n.errorMesh.clone()}),t.load(d.modelDir+d.doorModelFile,o=>{L=o.scene,L.scale.set(.42,.4,.3)},void 0,()=>{L=n.errorMesh.clone()}),ye(d.keySounds),lt(d.keySoundGroups)}function Wt(e){if(!ft)return;k!==null&&(n.physicsWorld.destroyBody(k),k=null),S.remove(E),S.remove(Z),S.remove(L),ie.intensity=0,j.intensity=0,Re=!1;const t=e;if(Se=t,t.deadends.length===0){t.key=!1,t.keyIndex=!1;return}const o=Math.floor(Math.random()*t.deadends.length);t.key=t.deadends[o],t.keyIndex=o,t.data[t.key.x][t.key.z]="K";const{x:r,z:i}=t.exit;t.data[r][i]="L";let s=t.exit.x,a=t.exit.z,c;t.exit.dir==="L"||t.exit.dir==="R"?(L.rotation.set(0,Ht,0),s+=t.exit.dir==="R"?.5:-.5,c=ut):(L.rotation.set(0,0,0),a+=t.exit.dir==="D"?.5:-.5,c=dt);const u={type:"static",position:{x:s,y:a},userData:"closed_door"};k=n.physicsWorld.createBody(u),k.createFixture({shape:c}),Z.position.set(t.key.x,0,t.key.z),S.add(Z),ie.position.set(t.key.x,.1,t.key.z),ie.intensity=.04,E.position.set(t.key.x,.38,t.key.z),S.add(E),j.position.set(t.key.x,.44,t.key.z),j.intensity=.1,Re=!0,L.position.set(s,0,a),S.add(L),ct.color=pn}function Ot(){return!ft||!Re||n.idleMode?!1:(E.rotateY(.03),E.rotateZ(.03),!0)}function Yt(){S.remove(E),j.intensity=0,Re=!1,I("keyPickup");const{x:e,z:t}=Se.exit;Se.data[e][t]="H",k!==null&&(n.physicsWorld.destroyBody(k),k=null);const o=Se.exit.dir;let r=L.position.x,i=L.position.z,s,a=0;o==="L"||o==="R"?(r+=o==="R"?.5:-.5,i+=.5,s=dt):(a=Ht,r+=.5,i+=o==="D"?.5:-.5,s=ut);const c={type:"static",position:{x:r,y:i},userData:"open_door"};k=n.physicsWorld.createBody(c),k.createFixture({shape:s}),L.position.set(r,0,i),L.rotation.set(0,a,0),ct.color=gn}const yn="key.js",mn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:yn,collect:Yt,create:Wt,loadAssets:hn,setup:Ut,update:Ot},Symbol.toStringTag,{value:"Module"})),vt=`

uniform float u_ticks;
uniform float u_opacity;
uniform vec3 u_rgb;
varying vec2 v_Uv;

float random(vec2 st) {
    return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
}

void main() {
    vec3 color = vec3(0.01);
    for (float i = 0.0; i < 10.0; i++) {
        float t = u_ticks * 0.1 + i;
        vec2 blobPos = vec2(random(vec2(i, t)) * 2.0 - 1.0, random(vec2(i + 1.0, t)) * 2.0 - 1.0);
        float d = length(v_Uv - blobPos);
        float intensity = clamp(0.01 / (d * d), 0.0, 0.3);
        color += vec3(intensity * u_rgb.r, intensity * u_rgb.g, intensity * u_rgb.b);
    }
    gl_FragColor = vec4(color, u_opacity);
}

`,bt=`

varying vec2 v_Uv;

void main() {
    v_Uv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}

`,{PI:ge}=Math,Me=ge/2,xn=ge*2;let ke,Vt,Xt,Kt,se,Ie=!1;const wn=new pe(.5,.01),Mn=new pe(.01,.5),z=[];let Ze,qe;function vn(e){new Tt(e).load(d.modelDir+d.teleportModelFile,o=>{ke=o.scene,ke.scale.set(.34,.34,2)},void 0,()=>{ke=n.errorMesh.clone()}),ye(d.teleportSounds)}function bn(){se=new it;const e=new At(.79,1.08);Ze=new yt({uniforms:{u_ticks:{value:1},u_opacity:{value:.6},u_rgb:{value:{r:.5,g:.5,b:0}}},vertexShader:bt,fragmentShader:vt,transparent:!0}),qe=new yt({uniforms:{u_ticks:{value:0},u_opacity:{value:.92},u_rgb:{value:{r:0,g:.4,b:.3}}},vertexShader:bt,fragmentShader:vt,transparent:!0}),Vt=new F(e,Ze),Xt=new F(e,qe);const t=new _t(1,d.mazeHeight,.14);Ln(t,.14),Kt=new F(t,se),n.physicsWorld.addContactCallback("ball","teleporter",kn),Ie=!0}function Ln(e,t){const o=e.getAttribute("uv");[0,4,10,14,21,23,25,27].forEach(r=>{o.array[r]=t}),[2,6,17,19].forEach(r=>{o.array[r]=0}),o.needsUpdate=!0}function Pn(e,t){if(!Ie||e.size.z<11)return;Sn(),se.map&&se.map.dispose(),se.map=t.clone();const o=Math.floor((e.size.z-1)/2);if(ve(1,0,o,"R",2),ve(2,e.size.x-1,o,"L",1),e.data[0][o]="T",e.data[e.size.x-1][o]="T",e.data[1][o]===!1&&(e.data[1][o]=""),e.data[e.size.x-2][o]===!1&&(e.data[e.size.x-2][o]=""),e.size.x>13){const r=Math.floor((e.size.x-1)/2);ve(3,r,0,"D",4),ve(4,r,e.size.z-1,"U",3),e.data[r][0]="T",e.data[r][e.size.z-1]="T",e.data[r][1]===!1&&(e.data[r][1]=""),e.data[r][e.size.z-2]===!1&&(e.data[r][e.size.z-2]="")}z.forEach(r=>{r.active&&n.scene.add(r.meshGroup)})}function Sn(){z.forEach(e=>{n.scene.remove(e.meshGroup),e.triggerBody!==null&&(n.physicsWorld.destroyBody(e.triggerBody),e.triggerBody=null),e.rearBoxBody!==null&&(n.physicsWorld.destroyBody(e.rearBoxBody),e.rearBoxBody=null),e.active=!1})}function ve(e,t,o,r,i){const s={x:0,z:0,meshRotation:0};let a;switch(r){case"R":s.x=-1,s.meshRotation=Me,a=-Me;break;case"L":s.x=1,s.meshRotation=-Me,a=Me;break;case"D":s.z=-1,s.meshRotation=0,a=0;break;case"U":s.z=1,s.meshRotation=ge,a=ge;break;default:console.warn("invalid entrySide value:",r);return}z[e]||(z[e]={meshGroup:null});const c=z[e];if(c.meshGroup===null){c.meshGroup=new bo;const f=ke.clone();f.position.set(0,0,.23),c.meshGroup.add(f);const p=Vt.clone();p.position.set(0,.5,-.12),c.meshGroup.add(p);const h=Xt.clone();h.position.set(0,.5,-.27),c.meshGroup.add(h);const y=Kt.clone();y.position.set(0,d.mazeHeight/2,-.43),c.meshGroup.add(y)}c.meshGroup.position.set(t,0,o),c.meshGroup.rotation.set(0,s.meshRotation,0);const u=s.x!==0?Mn:wn,l={type:"static",position:{x:t+s.x*.44,y:o+s.z*.44},userData:{name:"teleporter",id:e}};c.triggerBody=n.physicsWorld.createBody(l),c.triggerBody.createFixture({shape:u}),l.position={x:t+s.x*.5,y:o+s.z*.5},l.userData={},c.rearBoxBody=n.physicsWorld.createBody(l),c.rearBoxBody.createFixture({shape:u}),c.index=e,c.target=i,c.exit={x:t+s.x*.08,z:o+s.z*.08},c.cameraRotation=a,c.active=!0}function kn(e,t,o){if(!Ie)return;const r=z[o.id];if(!r.target){console.warn("no destination teleporter set:",o.id);return}if(!z[r.target]){console.warn("destination teleporter does not exist:",r.target);return}const i=z[r.target];if(!i.exit){console.warn("destination has no exit data:",r.target);return}const s=(i.cameraRotation-r.cameraRotation+ge)%xn,a=no().clone(),c=new vo(a.x,a.y);c.rotateAround({x:0,y:0},s),c.multiplyScalar(.75),so(i.exit,c,s),I("teleport")}function Dn(){return!Ie||n.idleMode?!1:(Ze.uniforms.u_ticks.value+=2e-7,qe.uniforms.u_ticks.value+=9e-8,!0)}const Lt=Math.PI/2,he=[],Fe=[],be=[],jt=[],m={x:0,z:0,type:""};let Y,De,ae,A,P,V,Je=.9;function Zt(){Y=n.scene,De=n.camera,ae=new Ce(65280,0),Y.add(ae),n.exitLight=ae,V={size:{x:0,z:0}},n.physicsWorld.addContactCallback("ball","wall",e=>{const t=e.getManifold().localNormal,o=e.getFixtureB().getBody().getLinearVelocity(),r=Math.abs(o.x*t.x),i=Math.abs(o.y*t.y);(r>Je||i>Je)&&(I("wallhit"),Oo())}),bn()}function En(e){const t=new Et(e);for(const o of d.wallTextureFiles)t.load(d.textureDir+"walls/"+o,r=>{r.colorSpace=Ye,he.push(r)},void 0,()=>{he.push(n.errorTexture)});for(const o of d.floorTextureFiles)t.load(d.textureDir+"floors/"+o,r=>{r.colorSpace=Ye,Fe.push(r)},void 0,()=>{Fe.push(n.errorTexture)});ye(d.mazeSounds),lt(d.mazeSoundGroups),vn(e)}function qt(e,t=.9){V=e,Je=t;const o=Math.floor(Math.random()*he.length);Pn(e,he[o]),be.length>0&&(be.forEach(p=>n.physicsWorld.destroyBody(p)),be.length=0);const r={type:"static",position:{x:0,y:0},userData:"wall"},i=new pe(.5,.5);for(let p=0;p<e.size.x;p++)for(let h=0;h<e.size.z;h++)if(e.data[p][h]===!1){r.position={x:p,y:h};const y=n.physicsWorld.createBody(r);be.push(y),y.createFixture({shape:i})}const s=e.size.x,a=e.size.z;A&&(Y.remove(A),A.geometry.dispose(),A.material.dispose(),A=null),P&&(Y.remove(P),P.geometry.dispose(),P.material.dispose(),P=null),A=An(e,o),A.castShadow=!0,A.receiveShadow=!0,Y.add(A);const c=Math.floor(Math.random()*Fe.length),u=Fe[c];u.wrapS=u.wrapT=Lo,u.repeat.set(s+15,a+15);const l=new At(s+15,a+15),f=new it({map:u});P=new F(l,f),P.rotateX(-Lt),P.position.set((s-1)/2,0,(a-1)/2),P.receiveShadow=!0,Y.add(P),n.firstPersonModeActive?De.rotation.set(0,e.start.angle,0):De.rotation.set(-Lt,0,0),De.position.set(e.start.x,n.cameraYpos,e.start.z),ae.position.set(e.exit.x,d.exitLightY,e.exit.z),ae.intensity=0,n.mazeExited=!1}function An(e,t){const o=new _t(1,d.mazeHeight,1),r=he[t],i=new it({map:r}),s=new Po(o,i,e.size.x*e.size.z);s.count=0;const a=new Dt;for(let c=0;c<e.size.x;c++)for(let u=0;u<e.size.z;u++)e.data[c][u]===!1&&(a.setPosition(c,d.mazeHeight/2,u),s.setMatrixAt(s.count++,a));return s}function Jt(e,t,o,r){Yo(r);const i=Math.floor(e+.5),s=Math.floor(o+.5),a={x:m.x,z:m.z},c={x:e,z:o};if(i===a.x&&s===a.z)return;const u=m.type;m.x=i,m.z=s,i>=0&&i<V.size.x&&s>=0&&s<V.size.z?m.type=V.data[m.x][m.z]:m.type="O",m.type!==u&&(m.type==="K"&&(Yt(),V.data[m.x][m.z]="D"),jt.forEach(l=>{(l.from===null||l.from===u)&&(l.to===null||l.to===m.type)&&l.callback(u,m.type,a,c)}))}function _n(e,t=null,o=null){jt.push({from:o,to:t,callback:e})}function pt(){return m}function Qt(){return Dn()}const Cn="maze.js",Tn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:Cn,create:qt,getPlayerGridInfo:pt,loadAssets:En,registerOnTypeChange:_n,setup:Zt,update:Qt,updatePlayerPosition:Jt},Symbol.toStringTag,{value:"Module"}));let Qe=1,le=-1,gt,q=null,ce=null,Ge=!1,Ne=!1;function zn(){ye(d.jumpSounds)}function Rn(e){gt=e.position.y,Te("jump",()=>{Ge||(Ge=!0,pt().type==="T"?Qe=.5:Qe=n.firstPersonModeActive?1.2:.6,le=-1,Ne=n.firstPersonModeActive,Ne&&(q=n.camera.position.y),ce=n.playerLight.position.y,I("jump"))})}function Fn(e){if(!Ge)return!1;if(n.firstPersonModeActive!==Ne)return q=null,et(e),!0;if(le+=.05,le>1)return et(e),!0;const t=1-le**2,o=Qe*t;return n.firstPersonModeActive&&(n.camera.position.y=q+o),e.position.y=gt+o,n.playerLight.position.y=ce+o,!0}function et(e){e.position.y=gt,ce!==null&&(n.playerLight.position.y=ce,ce=null),q!==null&&(n.firstPersonModeActive&&(n.camera.position.y=q),q=null),le=-1,Ge=!1}let R,me,X,J=0,Nt=()=>{console.warn("gUpdateMazePosition not set")},te=null,Ee=null,oe=null;const He=new Ct(0,0,0,"YZX"),Gn=new fe(0,0),eo=Math.PI/4,$n=Math.sin(eo),In=Math.cos(eo);function Bn(e){rn(e),zn()}function to(e){typeof e=="function"&&(Nt=e),[me,R]=sn(e),X=new Ce(16769248,d.playerLightLevel),X.castShadow=!1,n.scene.add(X),n.playerLight=X,Rn(R)}function tt(){if(te!==null&&(io(te.x,te.z),te=null,Ee!==null&&(oo(Ee),Ee=null),oe!==null&&(n.firstPersonModeActive&&(He.setFromQuaternion(n.camera.quaternion),He.y-=oe,n.camera.quaternion.setFromEuler(He),J+=oe),oe=null)),W!==0||O!==0){let t;if(W!==0&&O!==0?t=new fe(W*In,O*$n):t=new fe(W,O),t.mul(d.keyForce),n.firstPersonModeActive){const o=Math.cos(J),r=Math.sin(J),i=o*t.x-r*t.y,s=r*t.x+o*t.y;t.x=i,t.y=s}Hn(t)}n.playerLight.position.x=R.position.x,n.playerLight.position.z=R.position.z;let e=an();return e|=Fn(R),e&&(n.idleStartMs=0,n.idleMode=!1),!e&&!n.idleMode&&(n.idleStartMs===0?n.idleStartMs=Date.now():Date.now()-n.idleStartMs>d.idleTimeout*1e3&&(n.idleMode=!0)),e}function oo(e){me.setLinearVelocity(e)}function no(){return me.getLinearVelocity()}function ro(e){oo(Gn),io(e.start.x,e.start.z),J=-e.start.angle,X.position.set(e.start.x,d.lightYpos,e.start.z),X.intensity=0,et(R)}function io(e,t){const o=Be();R.position.set(e,o.y,t),me.setPosition({x:e,y:t}),Nt(e,o.y,t,0)}function so(e,t=null,o=null){te=e,Ee=t,oe=o}function Be(){return R.position}function ao(){return ln()}function Hn(e){me.applyForceToCenter(e)}function lo(){return J}function co(e){J=e}function ot(e){cn(e)}const Un="player.js",Wn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:Un,deferredPositionUpdate:so,getAngle:lo,getCameraHeight:ao,getLinearVelocity:no,getPosition:Be,hideMesh:ot,loadAssets:Bn,setAngle:co,setNewMaze:ro,setup:to,update:tt},Symbol.toStringTag,{value:"Module"}));let x;function On(e,t,o=document.body){n.renderUpdate=ht,n.cameraYpos=d.defaultCameraY,n.scene=new So,n.camera=new ko(80,window.innerWidth/window.innerHeight),n.renderer=new Do({antialias:!0}),n.renderer.shadowMap.enabled=d.enableShadows,n.renderer.shadowMap.type=Eo,o.appendChild(n.renderer.domElement),n.renderer.setPixelRatio(window.devicePixelRatio),n.renderer.setSize(e,t),window.addEventListener("resize",Xn),n.scene.background=new rt(d.bgColour),x=new Ao(16777215,d.sunLightLevel),x.castShadow=!0,x.position.set(5,20,5),x.shadow.camera.left=-10,x.shadow.camera.right=10,x.shadow.camera.top=0,x.shadow.camera.bottom=-20,x.shadow.camera.near=10,x.shadow.camera.far=25,n.scene.add(x),n.fog=new _o(d.bgColour,5,10),n.scene.fog=n.fog}function ht(e=!0){let t=!1;if(!n.orbitControlsEnabled){const o=Be();if(n.firstPersonModeActive)n.camera.position.x=o.x,n.camera.position.z=o.z;else{const r=o.x-n.camera.position.x,i=o.z-n.camera.position.z;if(r!==0||i!==0){t=!0;const s=n.mazeExited?d.cameraExitEase:d.cameraEase;s>=1||Math.abs(r)<.008&&Math.abs(i)<.008?(n.camera.position.x=o.x,n.camera.position.z=o.z):(n.camera.position.x+=r*s,n.camera.position.z+=i*s)}}}(e||t)&&n.renderer.render(n.scene,n.camera)}function Yn(){const e=.1*(d.playerLightLevel-n.playerLight.intensity),t=.1*(d.sunLightLevel-x.intensity);return n.playerLight.intensity+=e,x.intensity+=t,e<.01?(n.playerLight.intensity=d.playerLightLevel,n.exitLight.intensity=d.exitLightLevel,x.intensity=d.sunLightLevel,!0):!1}function Vn(){const e=.04*n.playerLight.intensity;return n.playerLight.intensity-=e,n.exitLight.intensity-=e,x.intensity-=e/2,e<.01?(n.playerLight.intensity=0,n.exitLight.intensity=0,x.intensity=0,!0):!1}function Xn(){n.camera.aspect=window.innerWidth/window.innerHeight,n.camera.updateProjectionMatrix(),n.renderer.setSize(window.innerWidth,window.innerHeight),ht()}var de=function(){var e=0,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",function(f){f.preventDefault(),r(++e%t.children.length)},!1);function o(f){return t.appendChild(f.dom),f}function r(f){for(var p=0;p<t.children.length;p++)t.children[p].style.display=p===f?"block":"none";e=f}var i=(performance||Date).now(),s=i,a=0,c=o(new de.Panel("FPS","#0ff","#002")),u=o(new de.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=o(new de.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:t,addPanel:o,showPanel:r,begin:function(){i=(performance||Date).now()},end:function(){a++;var f=(performance||Date).now();if(u.update(f-i,200),f>=s+1e3&&(c.update(a*1e3/(f-s),100),s=f,a=0,l)){var p=performance.memory;l.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return f},update:function(){i=this.end()},domElement:t,setMode:r}};de.Panel=function(e,t,o){var r=1/0,i=0,s=Math.round,a=s(window.devicePixelRatio||1),c=80*a,u=48*a,l=3*a,f=2*a,p=3*a,h=15*a,y=74*a,v=30*a,B=document.createElement("canvas");B.width=c,B.height=u,B.style.cssText="width:80px;height:48px";var g=B.getContext("2d");return g.font="bold "+9*a+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=o,g.fillRect(0,0,c,u),g.fillStyle=t,g.fillText(e,l,f),g.fillRect(p,h,y,v),g.fillStyle=o,g.globalAlpha=.9,g.fillRect(p,h,y,v),{dom:B,update:function(xe,po){r=Math.min(r,xe),i=Math.max(i,xe),g.fillStyle=o,g.globalAlpha=1,g.fillRect(0,0,c,h),g.fillStyle=t,g.fillText(s(xe)+" "+e+" ("+s(r)+"-"+s(i)+")",l,f),g.drawImage(B,p+a,h,y-a,v,p,h,y-a,v),g.fillRect(p+y-a,h,a,v),g.fillStyle=o,g.globalAlpha=.9,g.fillRect(p+y-a,h,a,s((1-xe/po)*v))}}};let Ue=!1,D,ue,Pt,$e;function Kn(){$e=new de,document.body.appendChild($e.dom),Te("orbit_controls",Zn),Te("house_lights",qn),D=new Go(n.camera,n.renderer.domElement),D.enableDamping=!0,D.enabled=!1,D.minPolarAngle=.02,D.maxPolarAngle=Math.PI-.05,ue=new Co(13421772,1),ue.intensity=0,n.scene.add(ue)}function jn(){return $e&&$e.update(),n.orbitControlsEnabled?(D.update(),!0):!1}function Zn(){if(n.firstPersonModeActive){console.log("Cannot activate orbit controls while in first person view");return}n.orbitControlsEnabled=!n.orbitControlsEnabled;const e=Be();n.orbitControlsEnabled?(console.log("Orbit controls enabled"),Pt=n.camera.position.y,D.target.set(e.x,e.y,e.z)):(console.log("Orbit controls disabled"),n.camera.position.x=e.x,n.camera.position.y=Pt,n.camera.position.z=e.z,n.camera.rotation.set(3*Math.PI/2,0,0),n.renderUpdate()),D.enabled=n.orbitControlsEnabled}function qn(){Ue=!Ue,Ue?(ue.intensity=1,n.scene.fog=null,console.log("House lights up")):(ue.intensity=0,n.scene.fog=n.fog,console.log("House lights down")),n.renderUpdate()}function Jn(){D&&D.target.set(n.camera.position.x,d.ballRadius,n.camera.position.z)}const H=new Ct(0,0,0,"YZX"),We=new To,Qn="pointerLockElement"in document;let Ae=0,_e=0;const nt=Math.PI/2;function Nn(){if(!Qn){console.log("browser does not support pointer lock, no first person view available");return}Te("first_person",er),document.addEventListener("pointerlockchange",()=>{if(n.orbitControlsEnabled){document.pointerLockElement&&(console.log("Cannot switch to first person view while orbit controls are active"),document.exitPointerLock());return}n.firstPersonModeActive?(document.exitPointerLock(),n.camera.rotation.set(-nt,0,0),n.camera.position.y=n.cameraYpos=d.defaultCameraY,nn(St),ot(!1),n.firstPersonModeActive=!1,console.log("first person view disabled")):(n.camera.rotation.set(0,-lo(),0),n.camera.position.y=n.cameraYpos=ao(),on(St),ot(!0),n.firstPersonModeActive=!0,console.log("first person view enabled")),n.renderUpdate()})}function er(){n.firstPersonModeActive?document.exitPointerLock():n.renderer.domElement.requestPointerLock()}function St(e){const t=e.movementX||e.mozMovementX||e.webkitMovementX||0;Ae=(e.movementY||e.mozMovementY||e.webkitMovementY||0)*d.mouseSensitivity,_e=t*d.mouseSensitivity}function tr(){if(!n.firstPersonModeActive)return!1;let e=!1;return(Ae!==0||_e!==0)&&(H.setFromQuaternion(n.camera.quaternion),H.x-=Ae,H.y-=_e,H.x=Math.max(-nt,Math.min(nt,H.x)),n.camera.quaternion.setFromEuler(H),n.camera.getWorldDirection(We),co(Math.atan2(We.x,-We.z)),Ae=0,_e=0,e=!0),e}Math.random=d.randomSeed?Ve(d.randomSeed):Ve();n.errorTexture=Vo();n.errorMesh=Xo();const w=Object.freeze({init:0,fadeIn:1,play:2,fadeOut:3,pause:4,idle:5});let Oe=1,_=w.init,uo=0;const{promise:or,resolve:nr}=Promise.withResolvers();document.addEventListener("DOMContentLoaded",()=>{uo=Uo(),je("Loading..."),Ko([Wn,Tn,mn,fn],nr)});await or;rr();function rr(){Qo(),On(window.innerWidth,window.innerHeight-uo),tn(),Kn(),Nn(),Zt(),Ut(),to(Jt),Gt(),requestAnimationFrame(fo)}function fo(){let e=!0;switch(_){case w.init:{Wo(Oe);const t=Math.random().toString().substring(2),o=5+Oe*2,r=qo(o,o,t);qt(r),Wt(r),ro(r),Jn(),_=w.fadeIn}break;case w.fadeIn:Yn()&&(_=w.play);break;case w.play:e=tt(),e|=tr(),e|=Ot(),e|=Qt(),pt().type==="O"&&(Oe++,n.mazeExited=!0,_=w.fadeOut,Bt("mazeExit"));break;case w.fadeOut:tt(),Vn()&&(_=w.pause);break;case w.pause:setTimeout(()=>{_=w.init},800),_=w.idle;break;case w.idle:break;default:console.log("game_loop(): Unknown game state: "+_),_=w.pause;break}e|=jn(),en(),ht(e),requestAnimationFrame(fo)}
