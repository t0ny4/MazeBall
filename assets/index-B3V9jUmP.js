import{ai as io,aj as mt,J as ao,X as F,ak as so,al as lo,m as xt,o as wt,j as He,l as De,am as Mt,an as co,a1 as uo,ao as fo,ap as po,h as Qe,D as go,aq as ho,ar as yo,V as mo,as as xo,at as wo,F as Mo,au as Je,av as vt,aw as st,ax as bt,a as vo,a0 as bo,w as Lo,I as Po}from"./three-oLj27GUe.js";import{W as So,V as le,C as ko,B as ce}from"./planck-C4Ttdjc7.js";import{N as q,G as Do}from"./keystrokes-BXin2WUB.js";import{O as Eo,G as Lt}from"./threeaddons-CZw3jlHJ.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();function Ie(...e){let t,o,n,i;if(e.length===0){const l=new Uint32Array(3);window.crypto.getRandomValues(l),e=[l[0],l[1],l[2]]}a(e);function a(l){const f=s();t=f(" "),o=f(" "),n=f(" "),i=1;for(let p=0;p<l.length;p++)t-=f(l[p]),t<0&&(t+=1),o-=f(l[p]),o<0&&(o+=1),n-=f(l[p]),n<0&&(n+=1)}function s(){let l=4022871197;function f(p){p=p.toString();const h=p.length;for(let y=0;y<h;y++){l+=p.charCodeAt(y);let M=.02519603282416938*l;l=M>>>0,M-=l,M*=l,l=M>>>0,M-=l,l+=M*4294967296}return(l>>>0)*23283064365386963e-26}return f}function c(l){return parseInt(l,10)===l}function u(){const l=2091639*t+i*23283064365386963e-26;return t=o,o=n,n=l-(i=l|0),n}return u.fract53=function(){return u()+(u()*2097152|0)*11102230246251565e-32},u.int32=function(){return u()*4294967296},u.cycle=function(l){l=typeof l>"u"?1:Number(l),l<1&&(l=1);for(let f=0;f<l;f++)u()},u.range=function(l=0,f=0){if(l===0&&f===0)return 0;if(l>f){const p=l;l=f,f=p}return c(l)&&c(f)?Math.floor(u()*(f-l+1))+l:u()*(f-l)+l},u.restart=function(){a(e)},u.seed=function(...l){a(l)},u}const _o={_MODULE:"global.js",cameraYpos:0,idleStartMs:0,firstPersonModeActive:!1,mazeExited:!1,orbitControlsEnabled:!1,idleMode:!1,camera:null,exitLight:null,fog:null,physicsWorld:null,playerLight:null,renderer:null,renderUpdate:()=>{console.warn("global.renderUpdate not set")},scene:null,errorTexture:null,errorMesh:null,statusBar:null},Ao={get(e,t){if(t in e)return e[t];throw console.error('Cannot read non existent property "'+t+'" from global'),new Error},set(e,t,o){if(t in e)return e[t]=o,!0;throw console.error('Cannot create new property "'+t+'" on global'),new Error},deleteProperty(e,t){throw console.error('Cannot delete property "'+t+'" from global'),new Error}},r=new Proxy(Object.seal(_o),Ao),Co={_MODULE:"config.js",ballRadius:.3,bgColour:1048576,playerLightLevel:.9,textureDir:"./textures/128/",randomSeed:0,soundsDir:"./sounds/",modelDir:"./models/",keyModelFile:"Key.glb",baseModelFile:"TeleporterBase.glb",doorModelFile:"ArchDoor.glb",keySounds:{keyPickup:{filename:"DM-CGS-07.ogg",volume:.4}},keySoundGroups:{},ballTextureFile:"Tile1.png",minVelocity:.1,exitLightY:.4,floorTextureFiles:["Tile8.png","Tile16.png","Tile24.png","Tile25.png"],mazeHeight:1.2,wallTextureFiles:["Tile11.png","Tile4.png","Tile18.png","Tile20.png","Tile21.png","Tile23.png"],mazeSounds:{locked:{filename:"DM-CGS-10.ogg",volume:.3},dm12:{filename:"DM-CGS-12.ogg",volume:.25},dm26:{filename:"DM-CGS-26.ogg",volume:.4},wallhit:{filename:"DM-CGS-03.ogg",volume:.05}},mazeSoundGroups:{mazeExit:["dm12","dm26"]},teleportModelFile:"ArchRound.glb",teleportSounds:{teleport:{filename:"DM-CGS-42.ogg",volume:.1}},controlKeys:{up:["ArrowUp","w","k"],down:["ArrowDown","s","j"],left:["ArrowLeft","a","h"],right:["ArrowRight","d","l"]},keys:{orbit_controls:"control>enter",house_lights:"shift>enter",first_person:"+"},mouseSensitivity:.005,idleTimeout:15,keyForce:.4,lightYpos:1.4,cameraEase:.08,cameraExitEase:.04,defaultCameraY:4,enableShadows:!0,exitLightLevel:.5,sunLightLevel:.4},To={get(e,t){if(t in e)return e[t];throw console.error('Cannot read non existent property "'+t+'" from config'),new Error},set(e,t){throw console.error('Cannot write to property "'+t+'" on config'),new Error},deleteProperty(e,t){throw console.error('Cannot delete property "'+t+'" from config'),new Error}},d=new Proxy(Object.freeze(Co),To);let C=null,lt=0,Ue=0,Ne=0,We=0,we=0,ct=0;function zo(){return C=document.createElement("div"),C.id="statusBar",C.classList.add("status"),document.body.append(C),lt=C===null?0:C.clientHeight,lt}function Oe(...e){C&&(C.innerHTML=e.join(" "))}function Ro(e){e!==Ue&&(Ue=e,Ne=0,We=0,et())}function Fo(){Ne++,et()}function Go(e){We+=e,we=Math.round(We),we!==ct&&(ct=we,et())}function et(){C.innerHTML="Level: "+Ue+" &nbsp; Distance Rolled: "+we+" &nbsp; Wall Impacts: "+Ne}function Bo(){const o=new Uint8Array(1024);for(let i=0;i<1024;i+=4)o[i]=255,o[i+1]=105,o[i+2]=180,o[i+3]=255;const n=new io(o,16,16);return n.needsUpdate=!0,n}function $o(){const e=new mt(.1),t=new ao({color:16738740});return new F(e,t)}function Ho(e,t){let o=!1,n=!1;const i=new so;i.onError=a=>{console.warn("Failed to load asset:",a),n=!0},i.onProgress=function(a,s,c){Oe("Loaded",Math.floor(s/c*100)+"%")},i.onLoad=()=>{o&&(n&&console.error("LoadingManager: finished loading asset files with errors"),Oe(""),t())},e.forEach(a=>{typeof a.loadAssets=="function"?a.loadAssets(i):console.warn(a,"has no loadAssets method")}),o=!0}const Io=Math.PI/2,H=Ie();function Uo(e,t,o){const n=e<3?3:e|1,i=t<3?3:t|1,a={x:n,z:i},s=o===void 0?Math.random().toString().substring(2):o;H.seed(s);const c={size:a,data:Array.from({length:a.x},()=>Array(a.z).fill(!1)),deadends:[],seed:s},u=Oo(a);return c.start=u.start,c.start.angle=0,c.end=u.end,c.exit=u.exit,c.data[c.exit.x][c.exit.z]="H",c}function Wo(e,t,o){const n=Uo(e,t,o);Pt(n,n.start.x,n.start.z);const{x:i,z:a}=n.start;let s=0;return n.data[i-1][a]!==!1?s=1:n.data[i][a+1]!==!1?s=2:n.data[i+1][a]!==!1&&(s=3),n.data[n.start.x][n.start.z]="S",n.data[n.end.x][n.end.z]="E",n.start.angle=s*Io,n}function Pt(e,t,o){let n=t===e.end.x&&o===e.end.z;for(;;){const i=[];let a;if(o<e.size.z-3&&e.data[t][o+2]===!1&&i.push([0,1]),t<e.size.x-3&&e.data[t+2][o]===!1&&i.push([1,0]),o>2&&e.data[t][o-2]===!1&&i.push([0,-1]),t>2&&e.data[t-2][o]===!1&&i.push([-1,0]),i.length===0)return n?e.data[t][o]="*":e.data[t][o]===!1&&(e.data[t][o]="D",e.deadends.push({x:t,z:o})),n;if(e.data[t][o]="",i.length===1?[a]=i:a=i[Math.floor(H()*i.length)],Pt(e,t+a[0]*2,o+a[1]*2)?(e.data[t+a[0]][o+a[1]]="*",n=!0):e.data[t+a[0]][o+a[1]]="",i.length===1)return n&&(e.data[t][o]="*"),n}}function Oo(e){const t={},o={};let n=H()>.5,i=H()>.5;t.x=i?1:e.x-2,t.z=n?1:e.z-2;const a=H();a>.5?(n=!n,i=!i):a>.25?n=!n:i=!i,o.x=i?1:e.x-2;const s=i?-1:1;o.z=n?1:e.z-2;const c=n?-1:1,u={...o};return H()>.5?(o.z+=c,o.dir=n?"U":"D"):(o.x+=s,o.dir=i?"L":"R"),{start:t,end:u,exit:o}}let te;const v={};function Yo(){te=new So({gravity:new le(0,0)}),r.physicsWorld=te,r.physicsWorld.addContactCallback=Vo,te.on("begin-contact",e=>{const t=e.m_nodeA.other.m_userData,o=e.m_nodeB.other.m_userData;if(t===void 0||o===void 0)return;const n=typeof t=="object"?t.name:t,i=typeof o=="object"?o.name:o;if(!v[n]||!v[n][i])return;const a=v[n][i],s=performance.now();if(!(s-a.last<250)){if(a.last=s,typeof a.callback=="function"){a.callback(e,t,o);return}a.callback.forEach(c=>{c(e,t,o)})}})}function Vo(e,t,o){if(v[e]||(v[e]={}),!v[e][t]){v[e][t]={},v[e][t].last=0,v[e][t].callback=o;return}if(typeof v[e][t].callback=="function"){const n=v[e][t].callback;v[e][t].callback=[n]}v[e][t].callback.push(o)}function Xo(){te.step(1/60),te.clearForces()}let I=0,U=0;function Ko(){function e(){U+=1}function t(){U-=1}function o(){I-=1}function n(){I+=1}q(d.controlKeys.up,{onPressed:t,onReleased:e}),q(d.controlKeys.down,{onPressed:e,onReleased:t}),q(d.controlKeys.left,{onPressed:o,onReleased:n}),q(d.controlKeys.right,{onPressed:n,onReleased:o})}function Zo(e){addEventListener("pointermove",e,!1)}function jo(e){removeEventListener("pointermove",e)}function Ye(e,t){if(!d.keys[e]){console.error("Unknown key index: "+e);return}const o=d.keys[e];o.includes(">")?Do(o,t):q(o,t)}const dt=new le(0,0),he=new xt,z=d.ballRadius,ut=d.minVelocity;let b,V,Me,St=()=>{console.warn("gUpdateMazePosition not set")};function qo(e){new wt(e).load(d.textureDir+"ball/"+d.ballTextureFile,o=>{Me=o,Me.colorSpace=He},void 0,()=>{Me=r.errorTexture})}function Qo(e){typeof e=="function"&&(St=e),V=r.physicsWorld.createBody({type:"dynamic",position:dt,awake:!1,fixedRotation:!0,userData:"ball"}),V.createFixture({shape:new ko(dt,z),restitution:.15,density:.2});const t=new mt(z),o=new lo({map:Me});return b=new F(t,o),b.position.y=z,b.castShadow=!0,r.scene.add(b),[V,b]}function Jo(){if(V.isAwake()){const i=V.getLinearVelocity();i.mul(.98),Math.abs(i.x)<ut&&Math.abs(i.y)<ut&&(i.x=0,i.y=0)}const e=V.getPosition(),t=e.y,o=e.x-b.position.x,n=t-b.position.z;if(o!==0||n!==0){b.position.set(e.x,z,t);const i=Math.sqrt(o*o+n*n);return St(e.x,z,t,i),r.firstPersonModeActive||(he.makeRotationZ(-o/z),b.matrix.premultiply(he),he.makeRotationX(n/z),b.matrix.premultiply(he),b.rotation.setFromRotationMatrix(b.matrix)),!0}return!1}function No(){return z}function en(e){b.visible=!e}let de,pe,W,X=0,kt=()=>{console.warn("gUpdateMazePosition not set")},Q=null,ve=null,J=null;const Fe=new Mt(0,0,0,"YZX"),tn=new le(0,0),Dt=Math.PI/4,on=Math.sin(Dt),nn=Math.cos(Dt);function rn(e){qo(e)}function Et(e){typeof e=="function"&&(kt=e),[pe,de]=Qo(e),W=new De(16769248,d.playerLightLevel),W.castShadow=!1,r.scene.add(W),r.playerLight=W}function Ve(){if(Q!==null&&(Tt(Q.x,Q.z),Q=null,ve!==null&&(_t(ve),ve=null),J!==null&&(r.firstPersonModeActive&&(Fe.setFromQuaternion(r.camera.quaternion),Fe.y-=J,r.camera.quaternion.setFromEuler(Fe),X+=J),J=null)),I!==0||U!==0){let t;if(I!==0&&U!==0?t=new le(I*nn,U*on):t=new le(I,U),t.mul(d.keyForce),r.firstPersonModeActive){const o=Math.cos(X),n=Math.sin(X),i=o*t.x-n*t.y,a=n*t.x+o*t.y;t.x=i,t.y=a}an(t)}r.playerLight.position.x=de.position.x,r.playerLight.position.z=de.position.z;const e=Jo();return e&&(r.idleStartMs=0,r.idleMode=!1),!e&&!r.idleMode&&(r.idleStartMs===0?r.idleStartMs=Date.now():Date.now()-r.idleStartMs>d.idleTimeout*1e3&&(r.idleMode=!0)),e}function _t(e){pe.setLinearVelocity(e)}function At(){return pe.getLinearVelocity()}function Ct(e){_t(tn),Tt(e.start.x,e.start.z),X=-e.start.angle,W.position.set(e.start.x,d.lightYpos,e.start.z),W.intensity=0}function Tt(e,t){const o=Te();de.position.set(e,o.y,t),pe.setPosition({x:e,y:t}),kt(e,o.y,t,0)}function zt(e,t=null,o=null){Q=e,ve=t,J=o}function Te(){return de.position}function Rt(){return No()}function an(e){pe.applyForceToCenter(e)}function Ft(){return X}function Gt(e){X=e}function Xe(e){en(e)}const sn="player.js",ln=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:sn,deferredPositionUpdate:zt,getAngle:Ft,getCameraHeight:Rt,getLinearVelocity:At,getPosition:Te,hideMesh:Xe,loadAssets:rn,setAngle:Gt,setNewMaze:Ct,setup:Et,update:Ve},Symbol.toStringTag,{value:"Module"}));let x;function cn(e,t,o=document.body){r.renderUpdate=tt,r.cameraYpos=d.defaultCameraY,r.scene=new co,r.camera=new uo(80,window.innerWidth/window.innerHeight),r.renderer=new fo({antialias:!0}),r.renderer.shadowMap.enabled=d.enableShadows,r.renderer.shadowMap.type=po,o.appendChild(r.renderer.domElement),r.renderer.setPixelRatio(window.devicePixelRatio),r.renderer.setSize(e,t),window.addEventListener("resize",fn),r.scene.background=new Qe(d.bgColour),x=new go(16777215,d.sunLightLevel),x.castShadow=!0,x.position.set(5,20,5),x.shadow.camera.left=-10,x.shadow.camera.right=10,x.shadow.camera.top=0,x.shadow.camera.bottom=-20,x.shadow.camera.near=10,x.shadow.camera.far=25,r.scene.add(x),r.fog=new ho(d.bgColour,5,10),r.scene.fog=r.fog}function tt(e=!0){let t=!1;if(!r.orbitControlsEnabled){const o=Te();if(r.firstPersonModeActive)r.camera.position.x=o.x,r.camera.position.z=o.z;else{const n=o.x-r.camera.position.x,i=o.z-r.camera.position.z;if(n!==0||i!==0){t=!0;const a=r.mazeExited?d.cameraExitEase:d.cameraEase;a>=1||Math.abs(n)<.008&&Math.abs(i)<.008?(r.camera.position.x=o.x,r.camera.position.z=o.z):(r.camera.position.x+=n*a,r.camera.position.z+=i*a)}}}(e||t)&&r.renderer.render(r.scene,r.camera)}function dn(){const e=.1*(d.playerLightLevel-r.playerLight.intensity),t=.1*(d.sunLightLevel-x.intensity);return r.playerLight.intensity+=e,x.intensity+=t,e<.01?(r.playerLight.intensity=d.playerLightLevel,r.exitLight.intensity=d.exitLightLevel,x.intensity=d.sunLightLevel,!0):!1}function un(){const e=.04*r.playerLight.intensity;return r.playerLight.intensity-=e,r.exitLight.intensity-=e,x.intensity-=e/2,e<.01?(r.playerLight.intensity=0,r.exitLight.intensity=0,x.intensity=0,!0):!1}function fn(){r.camera.aspect=window.innerWidth/window.innerHeight,r.camera.updateProjectionMatrix(),r.renderer.setSize(window.innerWidth,window.innerHeight),tt()}var oe=function(){var e=0,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",function(f){f.preventDefault(),n(++e%t.children.length)},!1);function o(f){return t.appendChild(f.dom),f}function n(f){for(var p=0;p<t.children.length;p++)t.children[p].style.display=p===f?"block":"none";e=f}var i=(performance||Date).now(),a=i,s=0,c=o(new oe.Panel("FPS","#0ff","#002")),u=o(new oe.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=o(new oe.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:t,addPanel:o,showPanel:n,begin:function(){i=(performance||Date).now()},end:function(){s++;var f=(performance||Date).now();if(u.update(f-i,200),f>=a+1e3&&(c.update(s*1e3/(f-a),100),a=f,s=0,l)){var p=performance.memory;l.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return f},update:function(){i=this.end()},domElement:t,setMode:n}};oe.Panel=function(e,t,o){var n=1/0,i=0,a=Math.round,s=a(window.devicePixelRatio||1),c=80*s,u=48*s,l=3*s,f=2*s,p=3*s,h=15*s,y=74*s,M=30*s,B=document.createElement("canvas");B.width=c,B.height=u,B.style.cssText="width:80px;height:48px";var g=B.getContext("2d");return g.font="bold "+9*s+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=o,g.fillRect(0,0,c,u),g.fillStyle=t,g.fillText(e,l,f),g.fillRect(p,h,y,M),g.fillStyle=o,g.globalAlpha=.9,g.fillRect(p,h,y,M),{dom:B,update:function(ge,ro){n=Math.min(n,ge),i=Math.max(i,ge),g.fillStyle=o,g.globalAlpha=1,g.fillRect(0,0,c,h),g.fillStyle=t,g.fillText(a(ge)+" "+e+" ("+a(n)+"-"+a(i)+")",l,f),g.drawImage(B,p+s,h,y-s,M,p,h,y-s,M),g.fillRect(p+y-s,h,s,M),g.fillStyle=o,g.globalAlpha=.9,g.fillRect(p+y-s,h,s,a((1-ge/ro)*M))}}};let Ge=!1,k,ne,ft,Ee;function pn(){Ee=new oe,document.body.appendChild(Ee.dom),Ye("orbit_controls",hn),Ye("house_lights",yn),k=new Eo(r.camera,r.renderer.domElement),k.enableDamping=!0,k.enabled=!1,k.minPolarAngle=.02,k.maxPolarAngle=Math.PI-.05,ne=new yo(13421772,1),ne.intensity=0,r.scene.add(ne)}function gn(){return Ee&&Ee.update(),r.orbitControlsEnabled?(k.update(),!0):!1}function hn(){if(r.firstPersonModeActive){console.log("Cannot activate orbit controls while in first person view");return}r.orbitControlsEnabled=!r.orbitControlsEnabled;const e=Te();r.orbitControlsEnabled?(console.log("Orbit controls enabled"),ft=r.camera.position.y,k.target.set(e.x,e.y,e.z)):(console.log("Orbit controls disabled"),r.camera.position.x=e.x,r.camera.position.y=ft,r.camera.position.z=e.z,r.camera.rotation.set(3*Math.PI/2,0,0),r.renderUpdate()),k.enabled=r.orbitControlsEnabled}function yn(){Ge=!Ge,Ge?(ne.intensity=1,r.scene.fog=null,console.log("House lights up")):(ne.intensity=0,r.scene.fog=r.fog,console.log("House lights down")),r.renderUpdate()}function mn(){k&&k.target.set(r.camera.position.x,d.ballRadius,r.camera.position.z)}const $=new Mt(0,0,0,"YZX"),Be=new mo,xn="pointerLockElement"in document;let be=0,Le=0;const Ke=Math.PI/2;function wn(){if(!xn){console.log("browser does not support pointer lock, no first person view available");return}Ye("first_person",Mn),document.addEventListener("pointerlockchange",()=>{if(r.orbitControlsEnabled){document.pointerLockElement&&(console.log("Cannot switch to first person view while orbit controls are active"),document.exitPointerLock());return}r.firstPersonModeActive?(document.exitPointerLock(),r.camera.rotation.set(-Ke,0,0),r.camera.position.y=r.cameraYpos=d.defaultCameraY,jo(pt),Xe(!1),r.firstPersonModeActive=!1,console.log("first person view disabled")):(r.camera.rotation.set(0,-Ft(),0),r.camera.position.y=r.cameraYpos=Rt(),Zo(pt),Xe(!0),r.firstPersonModeActive=!0,console.log("first person view enabled")),r.renderUpdate()})}function Mn(){r.firstPersonModeActive?document.exitPointerLock():r.renderer.domElement.requestPointerLock()}function pt(e){const t=e.movementX||e.mozMovementX||e.webkitMovementX||0;be=(e.movementY||e.mozMovementY||e.webkitMovementY||0)*d.mouseSensitivity,Le=t*d.mouseSensitivity}function vn(){if(!r.firstPersonModeActive)return!1;let e=!1;return(be!==0||Le!==0)&&($.setFromQuaternion(r.camera.quaternion),$.x-=be,$.y-=Le,$.x=Math.max(-Ke,Math.min(Ke,$.x)),r.camera.quaternion.setFromEuler($),r.camera.getWorldDirection(Be),Gt(Math.atan2(Be.x,-Be.z)),be=0,Le=0,e=!0),e}const N={},T={},G={},ee={};let re=null,_e=!1,Bt=!1;function bn(e){const t=new Mo(e);t.setResponseType("arraybuffer");for(const o in G)Object.hasOwn(G,o)&&t.load(d.soundsDir+G[o].filename,n=>{N[o]=n.transfer()})}function ze(e){for(const t in e)if(Object.hasOwn(e,t)){const o=e[t];typeof o=="string"?G[t]={filename:o,volume:1}:typeof o=="object"&&o.filename&&(G[t]={filename:o.filename},G[t].volume=o.volume?o.volume:1)}}function ot(e){for(const t in e)Object.hasOwn(e,t)&&(ee[t]=e[t])}function $t(){document.body.addEventListener("click",()=>{_e||It()},{once:!0}),Bt=/firefox/i.test(navigator.userAgent),document.body.addEventListener("keydown",Ht,{once:!0})}function Ht(e){if(Bt&&e.key.length>1){_e||document.body.addEventListener("keydown",Ht,{once:!0});return}_e||It()}function It(){re=new xo,r.camera.add(re);const e=new AudioContext;for(const t in N)Object.hasOwn(N,t)&&(T[t]||(T[t]=new wo(re),e.decodeAudioData(N[t],o=>{T[t].setBuffer(o),T[t].setLoop(!1),T[t].setVolume(G[t].volume),delete N[t]})));_e=!0}function j(e){return re===null?!0:T[e]?(T[e].isPlaying&&T[e].stop(),T[e].play(),!0):!1}function Ut(e){if(re===null)return!0;if(ee[e]){const t=ee[e].length;if(t>0){const o=Math.floor(Math.random()*t),n=ee[e][o];return j(n)?!0:(ee[e].splice(o,1),!1)}else return!1}return!1}const Ln="sounds.js",Pn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:Ln,addAssets:ze,addGroups:ot,loadAssets:bn,play:j,playFromGroup:Ut,setup:$t},Symbol.toStringTag,{value:"Module"})),Wt=Math.PI/2,Sn=new Qe(16711680),kn=new Qe(65280);let S,nt,E,K,Z,ie,L,D=null,rt,it,Pe,at=!1,Ae=!1;function Ot(){S=r.scene,nt=r.exitLight,ie=new De(16766720,0),S.add(ie),K=new De(16766720,0),S.add(K),rt=new ce(.5,.04),it=new ce(.04,.5),r.physicsWorld.addContactCallback("ball","closed_door",()=>{j("locked")}),at=!0}function Dn(e){const t=new Lt(e);t.load(d.modelDir+d.keyModelFile,o=>{E=o.scene,E.traverse(n=>{n instanceof F&&(n.material.emissive={b:0,r:1,g:.7,isColor:!0},n.material.emissiveIntensity=.55)}),E.scale.set(.6,.6,.6)},void 0,()=>{E=r.errorMesh.clone()}),t.load(d.modelDir+d.baseModelFile,o=>{Z=o.scene,Z.scale.set(.35,.1,.35)},void 0,()=>{Z=r.errorMesh.clone()}),t.load(d.modelDir+d.doorModelFile,o=>{L=o.scene,L.scale.set(.42,.4,.3)},void 0,()=>{L=r.errorMesh.clone()}),ze(d.keySounds),ot(d.keySoundGroups)}function Yt(e){if(!at)return;D!==null&&(r.physicsWorld.destroyBody(D),D=null),S.remove(E),S.remove(Z),S.remove(L),ie.intensity=0,K.intensity=0,Ae=!1;const t=e;if(Pe=t,t.deadends.length===0){t.key=!1,t.keyIndex=!1;return}const o=Math.floor(Math.random()*t.deadends.length);t.key=t.deadends[o],t.keyIndex=o,t.data[t.key.x][t.key.z]="K";const{x:n,z:i}=t.exit;t.data[n][i]="L";let a=t.exit.x,s=t.exit.z,c;t.exit.dir==="L"||t.exit.dir==="R"?(L.rotation.set(0,Wt,0),a+=t.exit.dir==="R"?.5:-.5,c=it):(L.rotation.set(0,0,0),s+=t.exit.dir==="D"?.5:-.5,c=rt);const u={type:"static",position:{x:a,y:s},userData:"closed_door"};D=r.physicsWorld.createBody(u),D.createFixture({shape:c}),Z.position.set(t.key.x,0,t.key.z),S.add(Z),ie.position.set(t.key.x,.1,t.key.z),ie.intensity=.04,E.position.set(t.key.x,.38,t.key.z),S.add(E),K.position.set(t.key.x,.44,t.key.z),K.intensity=.1,Ae=!0,L.position.set(a,0,s),S.add(L),nt.color=Sn}function Vt(){return!at||!Ae||r.idleMode?!1:(E.rotateY(.03),E.rotateZ(.03),!0)}function Xt(){S.remove(E),K.intensity=0,Ae=!1,j("keyPickup");const{x:e,z:t}=Pe.exit;Pe.data[e][t]="H",D!==null&&(r.physicsWorld.destroyBody(D),D=null);const o=Pe.exit.dir;let n=L.position.x,i=L.position.z,a,s=0;o==="L"||o==="R"?(n+=o==="R"?.5:-.5,i+=.5,a=rt):(s=Wt,n+=.5,i+=o==="D"?.5:-.5,a=it);const c={type:"static",position:{x:n,y:i},userData:"open_door"};D=r.physicsWorld.createBody(c),D.createFixture({shape:a}),L.position.set(n,0,i),L.rotation.set(0,s,0),nt.color=kn}const En="key.js",_n=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:En,collect:Xt,create:Yt,loadAssets:Dn,setup:Ot,update:Vt},Symbol.toStringTag,{value:"Module"})),gt=`

uniform float u_ticks;
uniform float u_opacity;
uniform vec3 u_rgb;
varying vec2 v_Uv;

float random(vec2 st) {
    return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
}

void main() {
    vec3 color = vec3(0.01);
    for (float i = 0.0; i < 10.0; i++) {
        float t = u_ticks * 0.1 + i;
        vec2 blobPos = vec2(random(vec2(i, t)) * 2.0 - 1.0, random(vec2(i + 1.0, t)) * 2.0 - 1.0);
        float d = length(v_Uv - blobPos);
        float intensity = clamp(0.01 / (d * d), 0.0, 0.3);
        color += vec3(intensity * u_rgb.r, intensity * u_rgb.g, intensity * u_rgb.b);
    }
    gl_FragColor = vec4(color, u_opacity);
}

`,ht=`

varying vec2 v_Uv;

void main() {
    v_Uv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}

`,{PI:ue}=Math,ye=ue/2,An=ue*2;let Se,Kt,Zt,jt,ae,Re=!1;const Cn=new ce(.5,.01),Tn=new ce(.01,.5),R=[];let Ze,je;function zn(e){new Lt(e).load(d.modelDir+d.teleportModelFile,o=>{Se=o.scene,Se.scale.set(.34,.34,2)},void 0,()=>{Se=r.errorMesh.clone()}),ze(d.teleportSounds)}function Rn(){ae=new Je;const e=new vt(.79,1.08);Ze=new st({uniforms:{u_ticks:{value:1},u_opacity:{value:.6},u_rgb:{value:{r:.5,g:.5,b:0}}},vertexShader:ht,fragmentShader:gt,transparent:!0}),je=new st({uniforms:{u_ticks:{value:0},u_opacity:{value:.92},u_rgb:{value:{r:0,g:.4,b:.3}}},vertexShader:ht,fragmentShader:gt,transparent:!0}),Kt=new F(e,Ze),Zt=new F(e,je);const t=new bt(1,d.mazeHeight,.14);Fn(t,.14),jt=new F(t,ae),r.physicsWorld.addContactCallback("ball","teleporter",$n),Re=!0}function Fn(e,t){const o=e.getAttribute("uv");[0,4,10,14,21,23,25,27].forEach(n=>{o.array[n]=t}),[2,6,17,19].forEach(n=>{o.array[n]=0}),o.needsUpdate=!0}function Gn(e,t){if(!Re||e.size.z<11)return;Bn(),ae.map&&ae.map.dispose(),ae.map=t.clone();const o=Math.floor((e.size.z-1)/2);if(me(1,0,o,"R",2),me(2,e.size.x-1,o,"L",1),e.data[0][o]="T",e.data[e.size.x-1][o]="T",e.data[1][o]===!1&&(e.data[1][o]=""),e.data[e.size.x-2][o]===!1&&(e.data[e.size.x-2][o]=""),e.size.x>13){const n=Math.floor((e.size.x-1)/2);me(3,n,0,"D",4),me(4,n,e.size.z-1,"U",3),e.data[n][0]="T",e.data[n][e.size.z-1]="T",e.data[n][1]===!1&&(e.data[n][1]=""),e.data[n][e.size.z-2]===!1&&(e.data[n][e.size.z-2]="")}R.forEach(n=>{n.active&&r.scene.add(n.meshGroup)})}function Bn(){R.forEach(e=>{r.scene.remove(e.meshGroup),e.triggerBody!==null&&(r.physicsWorld.destroyBody(e.triggerBody),e.triggerBody=null),e.rearBoxBody!==null&&(r.physicsWorld.destroyBody(e.rearBoxBody),e.rearBoxBody=null),e.active=!1})}function me(e,t,o,n,i){const a={x:0,z:0,meshRotation:0};let s;switch(n){case"R":a.x=-1,a.meshRotation=ye,s=-ye;break;case"L":a.x=1,a.meshRotation=-ye,s=ye;break;case"D":a.z=-1,a.meshRotation=0,s=0;break;case"U":a.z=1,a.meshRotation=ue,s=ue;break;default:console.warn("invalid entrySide value:",n);return}R[e]||(R[e]={meshGroup:null});const c=R[e];if(c.meshGroup===null){c.meshGroup=new bo;const f=Se.clone();f.position.set(0,0,.23),c.meshGroup.add(f);const p=Kt.clone();p.position.set(0,.5,-.12),c.meshGroup.add(p);const h=Zt.clone();h.position.set(0,.5,-.27),c.meshGroup.add(h);const y=jt.clone();y.position.set(0,d.mazeHeight/2,-.43),c.meshGroup.add(y)}c.meshGroup.position.set(t,0,o),c.meshGroup.rotation.set(0,a.meshRotation,0);const u=a.x!==0?Tn:Cn,l={type:"static",position:{x:t+a.x*.44,y:o+a.z*.44},userData:{name:"teleporter",id:e}};c.triggerBody=r.physicsWorld.createBody(l),c.triggerBody.createFixture({shape:u}),l.position={x:t+a.x*.5,y:o+a.z*.5},l.userData={},c.rearBoxBody=r.physicsWorld.createBody(l),c.rearBoxBody.createFixture({shape:u}),c.index=e,c.target=i,c.exit={x:t+a.x*.08,z:o+a.z*.08},c.cameraRotation=s,c.active=!0}function $n(e,t,o){if(!Re)return;const n=R[o.id];if(!n.target){console.warn("no destination teleporter set:",o.id);return}if(!R[n.target]){console.warn("destination teleporter does not exist:",n.target);return}const i=R[n.target];if(!i.exit){console.warn("destination has no exit data:",n.target);return}const a=(i.cameraRotation-n.cameraRotation+ue)%An,s=At().clone(),c=new vo(s.x,s.y);c.rotateAround({x:0,y:0},a),c.multiplyScalar(.75),zt(i.exit,c,a),j("teleport")}function Hn(){return!Re||r.idleMode?!1:(Ze.uniforms.u_ticks.value+=2e-7,je.uniforms.u_ticks.value+=9e-8,!0)}const yt=Math.PI/2,fe=[],Ce=[],xe=[],qt=[],m={x:0,z:0,type:""};let O,ke,se,_,P,Y,qe=.9;function Qt(){O=r.scene,ke=r.camera,se=new De(65280,0),O.add(se),r.exitLight=se,Y={size:{x:0,z:0}},r.physicsWorld.addContactCallback("ball","wall",e=>{const t=e.getManifold().localNormal,o=e.getFixtureB().getBody().getLinearVelocity(),n=Math.abs(o.x*t.x),i=Math.abs(o.y*t.y);(n>qe||i>qe)&&(j("wallhit"),Fo())}),Rn()}function In(e){const t=new wt(e);for(const o of d.wallTextureFiles)t.load(d.textureDir+"walls/"+o,n=>{n.colorSpace=He,fe.push(n)},void 0,()=>{fe.push(r.errorTexture)});for(const o of d.floorTextureFiles)t.load(d.textureDir+"floors/"+o,n=>{n.colorSpace=He,Ce.push(n)},void 0,()=>{Ce.push(r.errorTexture)});ze(d.mazeSounds),ot(d.mazeSoundGroups),zn(e)}function Jt(e,t=.9){Y=e,qe=t;const o=Math.floor(Math.random()*fe.length);Gn(e,fe[o]),xe.length>0&&(xe.forEach(p=>r.physicsWorld.destroyBody(p)),xe.length=0);const n={type:"static",position:{x:0,y:0},userData:"wall"},i=new ce(.5,.5);for(let p=0;p<e.size.x;p++)for(let h=0;h<e.size.z;h++)if(e.data[p][h]===!1){n.position={x:p,y:h};const y=r.physicsWorld.createBody(n);xe.push(y),y.createFixture({shape:i})}const a=e.size.x,s=e.size.z;_&&(O.remove(_),_.geometry.dispose(),_.material.dispose(),_=null),P&&(O.remove(P),P.geometry.dispose(),P.material.dispose(),P=null),_=Un(e,o),_.castShadow=!0,_.receiveShadow=!0,O.add(_);const c=Math.floor(Math.random()*Ce.length),u=Ce[c];u.wrapS=u.wrapT=Lo,u.repeat.set(a+15,s+15);const l=new vt(a+15,s+15),f=new Je({map:u});P=new F(l,f),P.rotateX(-yt),P.position.set((a-1)/2,0,(s-1)/2),P.receiveShadow=!0,O.add(P),r.firstPersonModeActive?ke.rotation.set(0,e.start.angle,0):ke.rotation.set(-yt,0,0),ke.position.set(e.start.x,r.cameraYpos,e.start.z),se.position.set(e.exit.x,d.exitLightY,e.exit.z),se.intensity=0,r.mazeExited=!1}function Un(e,t){const o=new bt(1,d.mazeHeight,1),n=fe[t],i=new Je({map:n}),a=new Po(o,i,e.size.x*e.size.z);a.count=0;const s=new xt;for(let c=0;c<e.size.x;c++)for(let u=0;u<e.size.z;u++)e.data[c][u]===!1&&(s.setPosition(c,d.mazeHeight/2,u),a.setMatrixAt(a.count++,s));return a}function Nt(e,t,o,n){Go(n);const i=Math.floor(e+.5),a=Math.floor(o+.5),s={x:m.x,z:m.z},c={x:e,z:o};if(i===s.x&&a===s.z)return;const u=m.type;m.x=i,m.z=a,i>=0&&i<Y.size.x&&a>=0&&a<Y.size.z?m.type=Y.data[m.x][m.z]:m.type="O",m.type!==u&&(m.type==="K"&&(Xt(),Y.data[m.x][m.z]="D"),qt.forEach(l=>{(l.from===null||l.from===u)&&(l.to===null||l.to===m.type)&&l.callback(u,m.type,s,c)}))}function Wn(e,t=null,o=null){qt.push({from:o,to:t,callback:e})}function eo(){return m}function to(){return Hn()}const On="maze.js",Yn=Object.freeze(Object.defineProperty({__proto__:null,_MODULE:On,create:Jt,getPlayerGridInfo:eo,loadAssets:In,registerOnTypeChange:Wn,setup:Qt,update:to,updatePlayerPosition:Nt},Symbol.toStringTag,{value:"Module"}));Math.random=d.randomSeed?Ie(d.randomSeed):Ie();r.errorTexture=Bo();r.errorMesh=$o();const w=Object.freeze({init:0,fadeIn:1,play:2,fadeOut:3,pause:4,idle:5});let $e=1,A=w.init,oo=0;const{promise:Vn,resolve:Xn}=Promise.withResolvers();document.addEventListener("DOMContentLoaded",()=>{oo=zo(),Oe("Loading..."),Ho([ln,Yn,_n,Pn],Xn)});await Vn;Kn();function Kn(){Yo(),cn(window.innerWidth,window.innerHeight-oo),Ko(),pn(),wn(),Qt(),Ot(),Et(Nt),$t(),requestAnimationFrame(no)}function no(){let e=!0;switch(A){case w.init:{Ro($e);const t=Math.random().toString().substring(2),o=5+$e*2,n=Wo(o,o,t);Jt(n),Yt(n),Ct(n),mn(),A=w.fadeIn}break;case w.fadeIn:dn()&&(A=w.play);break;case w.play:e=Ve(),e|=vn(),e|=Vt(),e|=to(),eo().type==="O"&&($e++,r.mazeExited=!0,A=w.fadeOut,Ut("mazeExit"));break;case w.fadeOut:Ve(),un()&&(A=w.pause);break;case w.pause:setTimeout(()=>{A=w.init},800),A=w.idle;break;case w.idle:break;default:console.log("game_loop(): Unknown game state: "+A),A=w.pause;break}e|=gn(),Xo(),tt(e),requestAnimationFrame(no)}
